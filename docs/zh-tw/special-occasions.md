# 特殊場合

## 1. 目的

**特殊場合**模組可協助您管理全年特殊場合並為其做準備，包括：
- 管理特殊場合（生日、節日等）
- 建立待辦事項清單（準備步驟）
- 為每個準備步驟附加檢查清單
- 場合前的提醒
- 追蹤準備進度

## 2. 使用時機

當您想：
- 管理全年特殊場合時
- 為重要場合做準備時
- 建立待辦事項清單時
- 在場合前收到提醒時

## 3. 相關畫面

- 特殊場合清單
- 新增特殊場合
- 場合詳細資訊和準備步驟
- 新增準備步驟
- 選擇檢查清單
- 建立新檢查清單

## 4. 主要使用方式

### 4.1 新增特殊場合

1. 前往**功能** → 選擇**特殊場合**
2. 點擊 **+** (FAB) 按鈕
3. 填寫資訊：
   - **場合名稱**：（例如：「媽媽的生日」）
   - **日期**：選擇日/月（DatePicker 僅選擇日/月，無年份）
   - **使用農曆**：（選填）如果要使用農曆，請勾選
     - 如果勾選：輸入農曆日期和月份，應用程式自動計算最近的陽曆日期
   - **重複**：每年 / 僅今年
   - **顯示通知時間**：選擇時間（必填，例如：07:00）
   - **備註**：其他資訊（選填）
4. （選填）新增準備步驟（見 4.2）
5. 點擊**儲存**

### 4.2 新增準備步驟

1. 新增場合時：在「準備步驟」區段點擊 **+ 新增步驟**
2. 或從場合詳細資訊：點擊 **+ 新增步驟**
3. 填寫資訊：
   - **何時？**：「X 天前」或「當天」
   - **天數**：（如果選擇「X 天前」）輸入場合前的天數
   - **顯示通知時間**：選擇時間（必填）
   - **完成前每日重複**：（選填）如果需要每日提醒，請勾選
   - **內容**：步驟名稱（必填，例如：「買禮物」）
   - **備註**：（選填）
   - **使用檢查清單**：（選填）勾選以連結購物檢查清單
4. 點擊**新增**（或 FAB「套用」）

### 4.3 建立檢查清單

1. 新增準備步驟時，勾選**使用檢查清單**
2. 「選擇購物檢查清單」畫面自動開啟
3. 點擊 FAB **+** 建立新檢查清單
4. 輸入檢查清單名稱
5. 新增項目：
   - 輸入項目名稱
   - 點擊 **+** 新增新項目
6. 點擊**儲存**
7. 新檢查清單自動選中並返回「新增準備步驟」畫面

### 4.4 將步驟標記為完成

1. 前往特殊場合詳細資訊
2. 找到要標記的步驟
3. 點擊核取方塊 [ ] 變更為 [✓]
4. 如果有檢查清單，點擊檢查清單名稱查看並勾選/取消勾選項目

### 4.5 查看進度

1. 前往特殊場合詳細資訊
2. 查看「概覽」區段：
   - 準備步驟：總步驟數
   - 已完成：已勾選步驟數 / 總步驟數
   - 狀態：未開始 / 進行中 / 已完成

### 4.6 編輯特殊場合

1. 前往特殊場合詳細資訊
2. 點擊標題中的超連結 **編輯 ›**
3. 編輯資訊：名稱、日期、重複、提醒時間、備註
4. 點擊**儲存**

### 4.7 編輯準備步驟

1. 前往特殊場合詳細資訊
2. 點擊要編輯的步驟（點擊整個項目，刪除圖示除外）
3. 編輯資訊：時間、內容、檢查清單
4. 點擊**套用**（或 FAB）

## 5. 範例與介面說明

### OCCASION-01：建立新特殊場合（帶準備步驟的生日）

**目標**：建立帶準備步驟的新特殊場合（生日），讓應用程式在場合發生前自動提醒您。

**主要步驟**：
1. 前往功能 → 特殊場合 → 點擊「+」(FAB) 按鈕
2. 輸入場合名稱，選擇日期（01/05），選擇重複「每年」，選擇提醒時間（07:00）
3. 新增準備步驟 1：「7 天前 – 08:00」-「買禮物」
4. 新增準備步驟 2：「1 天前 – 19:00」-「訂蛋糕」
5. 點擊「儲存」

**線框圖 - 新增特殊場合畫面**：

```text
┌──────────────────────────────────────────────┐
│ <  新增特殊場合                              │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│ 📝 場合資訊                                  │
│                                               │
│ 場合名稱 *                                    │
│ [ 安的生日                          ]        │
│                                               │
│ 日期                                          │
│ [ 01 / 05            ▼ ]                    │
│ （DatePicker 僅選擇日/月）                   │
│                                               │
│ [ ] 使用農曆                                  │
│                                               │
│ 重複                                          │
│ (•) 每年                                      │
│ ( ) 僅今年                                    │
│                                               │
│ 顯示通知時間 *                                │
│ [ 07:00        ▼ ]                            │
│                                               │
│ 備註（選填）                                  │
│ [                                      ]      │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│ 📋 準備步驟          [ + 新增步驟 ]          │
│ ┌──────────────────────────────────────────┐ │
│ │  1. 買禮物                   [圖示刪除] │ │
│ │     7 天前 – 08:00                       │ │
│ │ ──────────────────────────────────────── │ │
│ │  2. 訂蛋糕                   [圖示刪除] │ │
│ │     1 天前 – 19:00                       │ │
│ └──────────────────────────────────────────┘ │
└──────────────────────────────────────────────┘

        [ 取消 ]                        [ 儲存 ]
```

---

### OCCASION-02：使用農曆建立特殊場合（帶購物檢查清單的忌日）

**目標**：使用農曆建立特殊場合（忌日），帶有連結購物檢查清單的準備步驟以追蹤供品購買。

**主要步驟**：
1. 前往功能 → 特殊場合 → 點擊「+」(FAB) 按鈕
2. 輸入場合名稱「媽媽的忌日」，勾選「使用農曆」
3. 輸入農曆日期：15/11，應用程式自動計算陽曆日期：12/15/2025
4. 新增 3 個準備步驟，其中步驟 2 有檢查清單連結「買供品」
5. 點擊「儲存」

**線框圖 - 選擇農曆日期**：

```text
│ │ │ 農曆日期                                   │ │ │
│ │ │ 日（1-30）    月（1-12）                   │ │ │
│ │ │ [ 15 ]        [ 11 ]                       │ │ │
│ │ │                                               │ │ │
│ │ │ 陽曆日期（自動計算 - 僅顯示）                │ │ │
│ │ │ [ 文字：12/15/2025                 ]         │ │ │
│ │ │ （這是未來最近的陽曆日期）                    │ │ │
```

---

### OCCASION-03：查看特殊場合的清單和詳細資訊

**目標**：查看特殊場合的概覽，依時間篩選，並查看每個場合的詳細資訊和準備進度。

**主要步驟**：
1. 前往功能 → 特殊場合
2. 查看帶有篩選「全部」、「即將到來」、「本月」的清單
3. 點擊場合卡片查看詳細資訊
4. 查看概覽：步驟數、已完成、狀態
5. 勾選核取方塊將步驟標記為完成

**線框圖 - 特殊場合清單畫面**：

```text
┌────────────────────────────────────────────────────────────┐
│ 📅 特殊場合清單                                             │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [ + 新增場合 ]                                         │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 🔍 篩選：[ 全部 ]  [ 即將到來 ]  [ 本月 ]              │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📌 媽媽的忌日    [進行中] [圖示刪除]                   │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 📅 12/15/2025 • 15/11（農曆）• 剩餘 10 天          │ │ │
│ │ │                                                      │ │ │
│ │ │ ✅ 需要的準備步驟：                                  │ │ │
│ │ │   [✓] 3 天前 – 列出供品                             │ │ │
│ │ │   [ ] 1 天前 – 去買供品                             │ │ │
│ │ │   [ ] 當天 – 準備祭壇 / 儀式                        │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
```

**線框圖 - 特殊場合詳細資訊畫面**：

```text
┌─────────────────────────────────────────────────────────┐
│ 📋 特殊場合詳細資訊                                       │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📌 媽媽的忌日                       [編輯 ›]            │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 12/15/2025（陽曆）• 15/11（農曆）                  │ │ │
│ │ │ 剩餘 10 天 • 重複：每年                             │ │ │
│ │ │                                                      │ │ │
│ │ │ 備註：                                               │ │ │
│ │ │ 簡單餐點、白花、限制賓客。                          │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📊 概覽                                                │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 準備步驟：3                                        │ │ │
│ │ │ 已完成：1 / 3                                      │ │ │
│ │ │ 狀態：[進行中]                                    │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📝 準備步驟                  [ + 新增步驟 ]            │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ [✓] 列出供品                    [圖示刪除]          │ │ │
│ │ │     3 天前 – 08:00                                │ │ │
│ │ │     完成於 09:15 – 12/12/2025                      │ │ │
│ │ │ ──────────────────────────────────────────────────── │ │ │
│ │ │                                                      │ │ │
│ │ │ [ ] 去買供品            [圖示刪除]                 │ │ │
│ │ │     1 天前 – 19:00                                  │ │ │
│ │ │     完成前每日重複                                  │ │ │
│ │ │     購物檢查清單：買供品 ›                          │ │ │
│ │ │     [✓] 已完成 3 / 8 項目                           │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
```

---

### OCCASION-04：新增帶購物檢查清單的準備步驟

**目標**：為特殊場合新增準備步驟並連結購物檢查清單以追蹤購物。

**主要步驟**：
1. 前往特殊場合詳細資訊 → 點擊「+ 新增步驟」
2. 選擇「何時？」：「X 天前」，輸入天數：1
3. 選擇提醒時間：19:00
4. 啟用「完成前每日重複」
5. 輸入內容：「去買供品」
6. 勾選「使用檢查清單」→ 選擇檢查清單「買供品」
7. 點擊「新增」

**線框圖 - 新增準備步驟畫面**：

```text
┌────────────────────────────────────────────────────────────┐
│ ➕ 新增準備步驟                                             │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ ⏰ 準備時間                                              │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 何時？*（必填）                                     │ │ │
│ │ │ [ X 天前         ▼ ]                               │ │ │
│ │ │                                                      │ │ │
│ │ │ 天數 *（僅在選擇「X 天前」時顯示）                   │ │ │
│ │ │ [  1  ]  天前                                       │ │ │
│ │ │                                                      │ │ │
│ │ │ 顯示通知時間 *（必填）                              │ │ │
│ │ │ [ 19:00        ▼ ]                                 │ │ │
│ │ │                                                      │ │ │
│ │ │ [✓] 完成前每日重複                                  │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📝 內容                                                  │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 內容 *（必填）                                     │ │ │
│ │ │ [ 去買供品                               ]        │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 🔗 連結購物檢查清單？                                   │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ ☑ 使用檢查清單                                      │ │ │
│ │ │ 購物檢查清單：買供品 ›    [圖示交換]                │ │ │
│ │ │ （8 項目）                                          │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [ 取消 ]                        [ 新增 ]               │ │
│ └────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

---

### OCCASION-05：將準備步驟標記為完成並查看檢查清單進度

**目標**：將準備步驟標記為完成並追蹤購物檢查清單進度。

**主要步驟**：
1. 前往特殊場合詳細資訊
2. 查看顯示進度「已完成 3 / 8 項目」的帶檢查清單步驟
3. 點擊檢查清單名稱查看詳細資訊並勾選/取消勾選項目
4. 勾選步驟核取方塊將步驟標記為完成
5. 查看「概覽」即時更新

---

### OCCASION-06：編輯特殊場合和準備步驟

**目標**：建立後編輯特殊場合資訊和準備步驟。

**主要步驟**：
1. 前往特殊場合詳細資訊 → 點擊「編輯 ›」
2. 編輯場合名稱、備註
3. 點擊「儲存」
4. 點擊要編輯的步驟：變更時間、內容
5. 點擊刪除圖示刪除步驟（有確認對話框）

## 6. 邏輯與規則

### 6.1 農曆日期

- 您可以輸入陽曆和農曆日期
- 應用程式自動計算對應陽曆日期的農曆日期
- 支援按農曆每年重複

### 6.2 重複

- **每年**：場合每年重複（按陽曆或農曆）
  - 使用陽曆：每年根據 solarDate 的（日/月）計算 nextOccurDate
  - 使用農曆：每年從農曆日期轉換為對應的陽曆日期並更新 nextOccurDate
- **僅今年**：場合僅在目前年份有效，明年不重複

### 6.3 準備步驟

- **何時？**：有 2 個選項：
  - **X 天前**：在場合日期前 X 天提醒（必須輸入天數）
  - **當天**：在場合日期提醒（無需輸入天數）
- **顯示通知時間**：提醒時間（必填，格式 HH:mm）
- **完成前每日重複**：如果啟用，通知將每日重複，直到使用者將步驟標記為完成
- **連結檢查清單**：每個步驟可以附加購物檢查清單以追蹤購物進度

### 6.4 檢查清單

- 檢查清單可以重複用於多個步驟
- 追蹤已完成項目數 / 總項目數（例如：「已完成 3 / 8 項目」）
- 在步驟詳細資訊中顯示，帶有連結「檢查清單名稱 ›」以查看詳細資訊
- 可以在檢查清單中勾選/取消勾選項目以更新進度
- 即使檢查清單未完全完成，也可以將準備步驟標記為完成

### 6.5 通知

- **主要場合通知**：在 `nextOccurDate + reminder_time` 建立
  - 使用年度場合：應用程式啟動時將重建通知（基於新計算的 nextOccurDate）
  - 使用一次場合：通知僅為目前 nextOccurDate 建立一次
- **準備步驟通知**：根據以下項目計算提醒日期：
  - 特殊場合的 `nextOccurDate`
  - `reminderType` 和 `daysBefore`（如有）
  - `reminderTime`
- **重複通知**：如果 `repeatDailyUntilComplete = true`：
  - 建立每日重複通知
  - 使用 `notificationGroupKey` 分組重複通知
  - 使用者將步驟標記為完成時自動取消

## 7. 重要注意事項

- **農曆日期**： 
  - 應用程式自動轉換為陽曆以顯示
  - 找到與目前日期相比「未來最近的陽曆日期」
  - 未來年份：系統總是從（lunar_day, lunar_month）為每年重新計算對應的陽曆日期
  - 如果該年有同一月份的普通月和閏月：系統可能建立 2 個提醒以避免遺漏
- **每年重複**： 
  - 場合將在明年自動重新計算 nextOccurDate
  - 使用農曆：每年從農曆日期轉換為對應的陽曆日期
- **提醒時間**： 
  - 必須有值（不能為空）
  - 必須是正確格式 HH:mm（00:00 - 23:59）
- **檢查清單**： 
  - 已刪除的檢查清單仍顯示在步驟中（但無法編輯）
  - 即使檢查清單未完全完成，也可以將步驟標記為完成
- **通知**： 
  - 需要在設定中啟用通知以接收提醒
  - 標記步驟為完成時，重複通知將自動取消
- **場合狀態**：
  - **未開始**：所有步驟都未完成（灰色）
  - **進行中**：至少 1 個步驟已完成但並非全部（藍色）
  - **已完成**：所有步驟都已完成（深綠色）
  - 如果場合沒有準備步驟：狀態按日期計算（未開始 / 進行中 / 已完成）

