# 特別な日

## 1. 目的

**特別な日**モジュールは、一年を通じて特別な日を管理し、それらに備えるのに役立ちます：
- 特別な日の管理（誕生日、祝日など）
- やることリストの作成（準備ステップ）
- 各準備ステップにチェックリストを添付
- 特別な日の前のリマインド
- 準備進捗の追跡

## 2. 使用するタイミング

以下の場合にこのモジュールを使用します：
- 一年を通じて特別な日を管理
- 重要な日の準備
- やることリストを作成
- 特別な日の前にリマインドを受信

## 3. 関連画面

- 特別な日のリスト
- 新しい特別な日の追加
- 特別な日の詳細と準備ステップ
- 準備ステップの追加
- チェックリストの選択
- 新しいチェックリストの作成

## 4. 主な使用方法

### 4.1 特別な日を追加

1. **機能** → **特別な日**を選択
2. **+** (FAB) ボタンをタップ
3. 情報を入力：
   - **特別な日の名前**: （例：「母の誕生日」）
   - **日付**: 日/月を選択（DatePickerは日/月のみ選択、年は選択不可）
   - **旧暦を使用**: （任意）旧暦を使用する場合はチェック
     - チェックした場合: 旧暦の日と月を入力、アプリが最も近い太陽暦の日付を自動計算
   - **繰り返し**: 毎年 / 今年のみ
   - **通知を表示**: 時間を選択（必須、例：07:00）
   - **メモ**: 追加情報（任意）
4. （任意）準備ステップを追加（4.2を参照）
5. **保存**をタップ

### 4.2 準備ステップを追加

1. 新しい特別な日を追加する際: 「準備ステップ」セクションで**+ ステップを追加**をタップ
2. または特別な日の詳細から: **+ ステップを追加**をタップ
3. 情報を入力：
   - **いつ？**: 「X日前」または「当日」
   - **日数**: （「X日前」を選択した場合）特別な日の前の日数を入力
   - **通知を表示**: 時間を選択（必須）
   - **完了するまで毎日繰り返し**: （任意）毎日のリマインドを希望する場合はチェック
   - **内容**: ステップ名（必須、例：「プレゼントを買う」）
   - **メモ**: （任意）
   - **チェックリストを使用**: （任意）買い物チェックリストとリンクする場合はチェック
4. **追加**（またはFAB「適用」）をタップ

### 4.3 チェックリストを作成

1. 準備ステップを追加する際、**チェックリストを使用**にチェック
2. 「買い物チェックリストを選択」画面が自動的に開きます
3. FAB **+** をタップして新しいチェックリストを作成
4. チェックリスト名を入力
5. 項目を追加：
   - 項目名を入力
   - **+** をタップして新しい項目を追加
6. **保存**をタップ
7. 新しいチェックリストが自動的に選択され、「準備ステップを追加」画面に戻ります

### 4.4 ステップを完了としてマーク

1. 特別な日の詳細に移動
2. マークするステップを探す
3. チェックボックス [ ] をタップして [✓] に変更
4. チェックリストがある場合、チェックリスト名をタップして項目を表示し、チェック/チェック解除

### 4.5 進捗を表示

1. 特別な日の詳細に移動
2. 「概要」セクションを確認：
   - 準備ステップ: ステップの総数
   - 完了: チェックされたステップ数 / 総ステップ数
   - ステータス: 未開始 / 進行中 / 完了

### 4.6 特別な日を編集

1. 特別な日の詳細に移動
2. ヘッダーのハイパーリンク**編集 ›**をタップ
3. 情報を編集: 名前、日付、繰り返し、リマインド時間、メモ
4. **保存**をタップ

### 4.7 準備ステップを編集

1. 特別な日の詳細に移動
2. 編集するステップをタップ（削除アイコンを除く、項目全体をクリック）
3. 情報を編集: 時間、内容、チェックリスト
4. **適用**（またはFAB）をタップ

## 5. 例とUI図解

### OCCASION-01: 新しい特別な日を作成（準備ステップ付きの誕生日）

**目標**: 準備ステップ付きの新しい特別な日（誕生日）を作成して、アプリが特別な日の前に自動的にリマインドします。

**主な手順**:
1. 機能 → 特別な日 → "+" (FAB) ボタンをタップ
2. 特別な日の名前を入力、日付を選択（01/05）、繰り返し「毎年」を選択、リマインド時間を選択（07:00）
3. 準備ステップ1を追加: 「7日前 – 08:00」- 「プレゼントを買う」
4. 準備ステップ2を追加: 「1日前 – 19:00」- 「ケーキを注文する」
5. 「保存」をタップ

**ワイヤーフレーム - 特別な日追加画面**:

```text
┌──────────────────────────────────────────────┐
│ <  特別な日を追加                             │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│ 📝 特別な日の情報                              │
│                                               │
│ 特別な日の名前 *                               │
│ [ アンの誕生日                      ]         │
│                                               │
│ 日付                                           │
│ [ 01 / 05            ▼ ]                      │
│ （DatePickerは日/月のみ選択）                 │
│                                               │
│ [ ] 旧暦を使用                                   │
│                                               │
│ 繰り返し                                       │
│ (•) 毎年                                       │
│ ( ) 今年のみ                                   │
│                                               │
│ 通知を表示 *                                   │
│ [ 07:00        ▼ ]                             │
│                                               │
│ メモ（任意）                                   │
│ [                                      ]      │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│ 📋 準備ステップ          [ + ステップを追加 ]│
│ ┌──────────────────────────────────────────┐ │
│ │  1. プレゼントを買う          [アイコン 削除] │ │
│ │     7日前 – 08:00                         │ │
│ │ ──────────────────────────────────────── │ │
│ │  2. ケーキを注文する          [アイコン 削除] │ │
│ │     1日前 – 19:00                         │ │
│ └──────────────────────────────────────────┘ │
└──────────────────────────────────────────────┘

        [ キャンセル ]                        [ 保存 ]
```

---

### OCCASION-02: 旧暦を使用して特別な日を作成（買い物チェックリスト付きの命日）

**目標**: 旧暦を使用して特別な日（命日）を作成し、買い物チェックリストにリンクされた準備ステップで供物の購入を追跡します。

**主な手順**:
1. 機能 → 特別な日 → "+" (FAB) ボタンをタップ
2. 特別な日の名前「母の命日」を入力、「旧暦を使用」にチェック
3. 旧暦の日付を入力: 15/11、アプリが太陽暦の日付を自動計算: 2025/12/15
4. 3つの準備ステップを追加、ステップ2にチェックリストリンク「供物を買う」がある
5. 「保存」をタップ

**ワイヤーフレーム - 旧暦の日付を選択**:

```text
│ │ │ 旧暦の日付                                   │ │ │
│ │ │ 日（1-30）    月（1-12）                     │ │ │
│ │ │ [ 15 ]        [ 11 ]                         │ │ │
│ │ │                                               │ │ │
│ │ │ 太陽暦の日付（自動計算 - 表示のみ）          │ │ │
│ │ │ [ テキスト: 2025/12/15                 ]     │ │ │
│ │ │ （これは将来の最も近い太陽暦の日付です）      │ │ │
```

---

### OCCASION-03: 特別な日のリストと詳細を表示

**目標**: 特別な日の概要を表示し、時間でフィルタリングし、準備進捗を含む各特別な日の詳細を表示します。

**主な手順**:
1. 機能 → 特別な日に移動
2. フィルタ「すべて」、「近日中」、「今月」でリストを表示
3. 特別な日のカードをタップして詳細を表示
4. 概要を確認: ステップ数、完了、ステータス
5. チェックボックスにチェックしてステップを完了としてマーク

**ワイヤーフレーム - 特別な日のリスト画面**:

```text
┌────────────────────────────────────────────────────────────┐
│ 📅 特別な日のリスト                                          │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [ + 特別な日を追加 ]                                   │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 🔍 フィルタ: [ すべて ]  [ 近日中 ]  [ 今月 ]          │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📌 母の命日    [進行中] [アイコン 削除]               │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 📅 2025/12/15 • 15/11（旧暦） • 残り10日          │ │ │
│ │ │                                                      │ │ │
│ │ │ ✅ 準備ステップが必要:                              │ │ │
│ │ │   [✓] 3日前 – 供物リスト                           │ │ │
│ │ │   [ ] 1日前 – 供物を買いに行く                     │ │ │
│ │ │   [ ] 当日 – 祭壇/儀式を準備                       │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
```

**ワイヤーフレーム - 特別な日の詳細画面**:

```text
┌─────────────────────────────────────────────────────────┐
│ 📋 特別な日の詳細                                         │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📌 母の命日                       [編集 ›]        │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 2025/12/15（太陽暦） • 15/11（旧暦）              │ │ │
│ │ │ 残り10日 • 繰り返し: 毎年                          │ │ │
│ │ │                                                      │ │ │
│ │ │ メモ:                                               │ │ │
│ │ │ 小さな食事、白い花、ゲストを制限。                │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📊 概要                                             │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 準備ステップ: 3                                    │ │ │
│ │ │ 完了: 1 / 3                                       │ │ │
│ │ │ ステータス: [進行中]                               │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📝 準備ステップ                  [ + ステップを追加 ]                  │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ [✓] 供物リスト                    [アイコン 削除]           │ │ │
│ │ │     3日前 – 08:00                                │ │ │
│ │ │     完了時刻 09:15 – 2025/12/12                   │ │ │
│ │ │ ──────────────────────────────────────────────────── │ │ │
│ │ │                                                      │ │ │
│ │ │ [ ] 供物を買いに行く                    [アイコン 削除]            │ │ │
│ │ │     1日前 – 19:00                                  │ │ │
│ │ │     完了するまで毎日繰り返し                        │ │ │
│ │ │     買い物チェックリスト: 供物を買う ›              │ │ │
│ │ │     [✓] 完了 3 / 8 項目                            │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
```

---

### OCCASION-04: 買い物チェックリスト付きの準備ステップを追加

**目標**: 特別な日の新しい準備ステップを追加し、買い物チェックリストとリンクして買い物を追跡します。

**主な手順**:
1. 特別な日の詳細 → 「+ ステップを追加」をタップ
2. 「いつ？」を選択: 「X日前」、日数を入力: 1
3. リマインド時間を選択: 19:00
4. 「完了するまで毎日繰り返し」を有効化
5. 内容を入力: 「供物を買いに行く」
6. 「チェックリストを使用」にチェック → チェックリスト「供物を買う」を選択
7. 「追加」をタップ

**ワイヤーフレーム - 準備ステップ追加画面**:

```text
┌────────────────────────────────────────────────────────────┐
│ ➕ 準備ステップを追加                                        │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ ⏰ 準備時間                                            │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ いつ？ * （必須）                                  │ │ │
│ │ │ [ X日前         ▼ ]                               │ │ │
│ │ │                                                      │ │ │
│ │ │ 日数 * （「X日前」を選択した場合のみ表示）         │ │ │
│ │ │ [  1  ]  日前                                      │ │ │
│ │ │                                                      │ │ │
│ │ │ 通知を表示 * （必須）                              │ │ │
│ │ │ [ 19:00        ▼ ]                                 │ │ │
│ │ │                                                      │ │ │
│ │ │ [✓] 完了するまで毎日繰り返し                        │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📝 内容                                                 │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 内容 * （必須）                                    │ │ │
│ │ │ [ 供物を買いに行く                       ]        │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 🔗 買い物チェックリストとリンクしますか？              │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ ☑ チェックリストを使用                              │ │ │
│ │ │ 買い物チェックリスト: 供物を買う ›    [アイコン 交換]  │ │ │
│ │ │ （8項目）                                          │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [ キャンセル ]                        [ 追加 ]         │ │
│ └────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

---

### OCCASION-05: 準備ステップを完了としてマークし、チェックリストの進捗を表示

**目標**: 準備ステップを完了としてマークし、買い物チェックリストの進捗を追跡します。

**主な手順**:
1. 特別な日の詳細に移動
2. 進捗「完了 3 / 8 項目」を表示するチェックリスト付きステップを確認
3. チェックリスト名をタップして詳細を表示し、項目をチェック/チェック解除
4. ステップのチェックボックスにチェックして完了としてマーク
5. 「概要」がリアルタイムで更新されるのを確認

---

### OCCASION-06: 特別な日と準備ステップを編集

**目標**: 作成後に特別な日の情報と準備ステップを編集します。

**主な手順**:
1. 特別な日の詳細 → 「編集 ›」をタップ
2. 特別な日の名前、メモを編集
3. 「保存」をタップ
4. 編集するステップをタップ: 時間、内容を変更
5. 削除アイコンをタップしてステップを削除（確認ダイアログあり）

## 6. ロジックとルール

### 6.1 旧暦の日付

- 太陽暦と旧暦の両方の日付を入力できます
- アプリが旧暦の日付に対応する太陽暦の日付を自動計算します
- 旧暦による毎年の繰り返しをサポートします

### 6.2 繰り返し

- **毎年**: 特別な日は毎年繰り返されます（太陽暦または旧暦）
  - 太陽暦の場合: 毎年、solarDateの（日/月）に基づいてnextOccurDateを計算
  - 旧暦の場合: 毎年、旧暦の日付から対応する太陽暦の日付に変換し、nextOccurDateを更新
- **今年のみ**: 特別な日は今年のみ有効で、来年は繰り返されません

### 6.3 準備ステップ

- **いつ？**: 2つのオプションがあります：
  - **X日前**: 特別な日のX日前にリマインド（日数を入力する必要があります）
  - **当日**: 特別な日の当日にリマインド（日数を入力する必要はありません）
- **通知を表示**: リマインド時間（必須、形式HH:mm）
- **完了するまで毎日繰り返し**: 有効化すると、ユーザーがステップを完了としてマークするまで、通知が毎日繰り返されます
- **チェックリストをリンク**: 各ステップは買い物チェックリストを添付して、買い物の進捗を追跡できます

### 6.4 チェックリスト

- チェックリストは複数のステップで再利用できます
- 完了した項目数 / 総項目数を追跡（例：「完了 3 / 8 項目」）
- ステップ詳細に「チェックリスト名 ›」のリンクで表示され、詳細を表示できます
- チェックリスト内の項目をチェック/チェック解除して進捗を更新できます
- チェックリストが完全に完了していなくても、準備ステップを完了としてマークできます

### 6.5 通知

- **メインの特別な日の通知**: `nextOccurDate + reminder_time`で作成
  - 毎年の特別な日: アプリ起動時に通知が再構築されます（新しく計算されたnextOccurDateに基づく）
  - 一度限りの特別な日: 現在のnextOccurDateに対して一度だけ通知が作成されます
- **準備ステップの通知**: 以下に基づいてリマインド日を計算：
  - 特別な日の`nextOccurDate`
  - `reminderType`と`daysBefore`（ある場合）
  - `reminderTime`
- **繰り返し通知**: `repeatDailyUntilComplete = true`の場合：
  - 毎日の繰り返し通知を作成
  - `notificationGroupKey`を使用して繰り返し通知をグループ化
  - ユーザーがステップを完了としてマークすると自動的にキャンセル

## 7. 重要な注意事項

- **旧暦の日付**: 
  - アプリが表示のために太陽暦に自動変換します
  - 現在の日付と比較して「将来の最も近い太陽暦の日付」を見つけます
  - 将来の年: システムは常に各年の（旧暦の日、旧暦の月）から対応する太陽暦の日付を再計算します
  - その年に同じ月の通常月と閏月の両方がある場合: システムは見逃しを避けるために2つのリマインドを作成する場合があります
- **毎年の繰り返し**: 
  - 特別な日は来年自動的にnextOccurDateを再計算します
  - 旧暦の場合: 毎年、旧暦の日付から対応する太陽暦の日付に変換します
- **リマインド時間**: 
  - 値が必要です（空にできません）
  - 正しい形式HH:mm（00:00 - 23:59）である必要があります
- **チェックリスト**: 
  - 削除されたチェックリストはステップに表示されます（ただし編集できません）
  - チェックリストが完全に完了していなくても、ステップを完了としてマークできます
- **通知**: 
  - リマインドを受信するには、設定で通知を有効化する必要があります
  - ステップを完了としてマークすると、繰り返し通知が自動的にキャンセルされます
- **特別な日のステータス**:
  - **未開始**: すべてのステップが完了していない（グレー）
  - **進行中**: 少なくとも1つのステップが完了しているが、すべてではない（青）
  - **完了**: すべてのステップが完了している（濃い緑）
  - 特別な日に準備ステップがない場合: ステータスは日付で計算されます（未開始 / 進行中 / 完了）

