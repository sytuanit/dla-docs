# 定期収入

## 1. 目的

**定期収入**モジュールは、以下のような定期的な収入源を管理するのに役立ちます：
- 月給
- 家賃収入
- 年金
- 投資配当
- その他の定期収入

このモジュールは、設定したサイクルに基づいて自動的に**発生**を作成し、支払い受領の時期をリマインドします。

## 2. 使用するタイミング

以下の場合にこのモジュールを使用します：
- スケジュールに沿った固定収入（週次、隔週、月次）
- 支払い受領の確認と追跡が必要
- 月次予算への自動計算を希望

## 3. 関連画面

- 定期収入リスト
- 新しい定期収入の追加
- 定期収入の編集
- 発生履歴

## 4. 主な使用方法

### 4.1 新しい定期収入を追加

1. **機能** → **定期収入**を選択
2. 右下の **+** (FAB) ボタンをタップ
3. 情報を入力：
   - **カテゴリ**: カテゴリを選択または新規作成
   - **金額**: 収入額を入力（空白のままにしておき、確認時に入力することも可能）
   - **サイクル**: 週次 / 隔週 / 月次を選択
   - **日付**: サイクル内の日付を選択（例：毎月15日）
   - **開始日**: （隔週サイクルのみ）開始日を選択
   - **メモ**: 追加情報（任意）
4. **保存**をタップ

### 4.2 支払い受領を確認

1. 定期収入リストに移動
2. **「確認待ち」**バッジ（黄色）が付いた項目を探す
3. 項目をタップして確認ダイアログを開く
4. 入力：
   - **実際の金額**: （予想と異なる場合）
   - **メモ**: （任意）
5. **確認**をタップ

### 4.3 定期収入を編集

1. 定期収入リストに移動
2. 編集する項目をタップ
3. メニューから**編集**を選択
4. 情報を更新
5. **保存**をタップ

### 4.4 履歴を表示

1. 定期収入リストに移動
2. 項目をタップ
3. **履歴**を選択して過去のすべての発生を表示

### 4.5 収入を無効化/有効化

1. 定期収入リストに移動
2. 無効化/有効化する項目を探す
3. 項目の右側の**アクティブ**スイッチを切り替え

## 5. 例とUI図解

### 5.1 例1: 月次定期収入（給与）を作成

**シナリオ**: 月給を追跡して、支払い受領の時期にアプリが自動的にリマインドするようにします。

**手順**:
1. 機能画面に移動し、「定期収入」を選択
2. 右下の「➕ 新規追加」ボタンをタップ
3. カテゴリ「給与」を選択（利用できない場合は新規作成）
4. 金額を入力: ¥400,000
5. サイクル「月次」を選択
6. 「月の日を選択」を選択し、5を入力
7. メモに自動入力「月給」（編集可能）
8. 「保存」をタップ

**結果**: アプリが成功メッセージを表示し、リストに戻ります。新しい項目が完全な情報と共に表示され、アプリは毎月5日に自動的にリマインドします。

**定期収入追加画面**:

```text
┌─────────────────────────────────────────┐
│  ← 戻る    定期収入を追加                │
├─────────────────────────────────────────┤
│  カテゴリ *                              │
│  [給与 ▼] [+ 新規追加]                   │
│                                         │
│  金額 (JPY) *                            │
│  [¥400,000]                             │
│                                         │
│  サイクル *                               │
│  ┌──────┐ ┌────────┐ ┌────────┐        │
│  │週次  │ │隔週    │ │月次    │        │
│  └──────┘ └────────┘ └────────┘        │
│                                         │
│  サイクル内の支払い日                    │
│  ⚪ 月末                                 │
│  ⚫ 月の日を選択                          │
│  ┌───────────────────────────────────┐ │
│  │ 月の日: [5]                         │ │
│  └───────────────────────────────────┘ │
│                                         │
│  メモ                                    │
│  ┌───────────────────────────────────┐ │
│  │ 月給                                │ │
│  └───────────────────────────────────┘ │
│                                         │
│  [キャンセル]              [保存]       │
└─────────────────────────────────────────┘
```

---

### 5.2 例2: 期日収入を確認し、実際の金額を更新

**シナリオ**: 給料日（5日）ですが、設定した¥400,000ではなく、実際に受領した金額は¥420,000（給与増額）です。

**手順**:
1. アプリを開くか「定期収入」画面に移動
2. アプリが期日発生を自動検出し、確認ダイアログを表示
3. ダイアログにデフォルト金額を表示: ¥400,000
4. 実際の金額を¥420,000に更新
5. メモを入力: 「今月はボーナスあり」（任意）
6. 「受領確認」をタップ

**結果**: アプリが実際の金額¥420,000で確認された発生を更新し、次の発生を自動的に作成し、現在の財務残高を更新します。

**収入確認ダイアログ**:

```text
┌─────────────────────────────────────────┐
│  受領確認                                │
├─────────────────────────────────────────┤
│  給与                                    │
│  月次（5日）                             │
│  期日: 今日                              │
│                                         │
│  実際の金額 *                             │
│  [¥420,000]                             │
│                                         │
│  メモ                                    │
│  [今月はボーナスあり]                    │
│                                         │
│  [キャンセル]    [受領確認]             │
└─────────────────────────────────────────┘
```

---

### 5.3 例3: 支払いが受領されなかった場合に収入発生をキャンセル

**シナリオ**: 家賃支払い日（1日）ですが、入居者が送金していないため、支払いが受領されませんでした。

**手順**:
1. アプリを開くか「定期収入」画面に移動
2. アプリが期日発生の確認ダイアログを表示
3. 「キャンセル」ボタンをタップ
4. 理由を入力: 「入居者が送金していない」（必須）
5. 「キャンセル確認」をタップ

**結果**: キャンセルされた発生が「キャンセル済み」ステータスに変更され、キャンセル理由が表示され、アプリが次の発生を自動的に作成します。支払いが受領されなかったため、財務残高は変更されません。

**収入発生キャンセルダイアログ**:

```text
┌─────────────────────────────────────────┐
│  キャンセル                              │
├─────────────────────────────────────────┤
│  家賃収入                                │
│  月次（1日）                             │
│  期日: 今日                              │
│                                         │
│  キャンセル理由 *                         │
│  ┌───────────────────────────────────┐ │
│  │ 入居者が送金していない              │ │
│  └───────────────────────────────────┘ │
│                                         │
│  [戻る]        [キャンセル確認]         │
└─────────────────────────────────────────┘
```

---

## 6. ロジックとルール

### 6.1 サイクルと日付

- **週次**: 曜日を選択（1=月曜日、7=日曜日）
- **隔週**: 曜日 + 特定の開始日を選択
- **月次**: 月の日を選択（1-31）

### 6.2 発生の自動作成

- アプリは以下の場合に自動的に**発生**を作成します：
  - 新しい収入を追加するとき
  - サイクル内の日付に到達したとき
  - 新しい月が始まったとき

### 6.3 発生ステータス

- **PENDING**: 確認待ち（黄色バッジを表示）
- **COMPLETED**: 確認済み（緑色バッジを表示）
- **CANCELLED**: キャンセル済み（赤色バッジを表示）

### 6.4 予算との統合

- 収入を確認すると、アプリは現在の月の予算（存在する場合）を自動的に更新します
- 収入は予算の「定期収入」に計算されます

### 6.5 通知

- 支払い期日になると、アプリがリマインド通知を送信します
- 各項目の通知時間を設定できます（`notificationTime1`、`notificationTime2`、デフォルトは16:00と19:00）

## 7. 重要な注意事項

- **金額は空白にできます**: 正確な金額がわからない場合は、空白のままにしておき、確認時に入力できます
- **発生が存在する場合は削除できません**: 発生がある場合、無効化（isActive = false）のみ可能で、削除はできません
- **遅延確認**: 過去の発生を確認でき、アプリが予算を自動的に再計算します
- **サイクルの変更**: サイクルを編集すると、将来の発生が再計算されます

