# 待办事项清单

## 1. 目的

**待办事项清单**模块可帮助您管理重复性任务并追踪完成进度，包括：
- 基于时间的重复性任务（每日/每周/每月/每年）
- 基于指标的重复性任务（英里/小时/次数...）
- 到期时的提醒
- 完成历史追踪
- 支出记录（如适用）

此模块可帮助您不错过重要任务，如汽车保养、过滤器更换、定期检查等。

## 2. 使用时机

当您有：
- 按计划重复的任务时（例如：每 3 个月更换水过滤器）
- 基于指标重复的任务时（例如：每 3,000 英里更换汽车机油）
- 需要到期时自动提醒时
- 想追踪完成历史时
- 需要记录相关支出时

## 3. 相关画面

- 待办事项清单画面
- 选择任务类型（基于时间 / 基于指标）
- 新增待办事项
- 编辑待办事项
- 确认基于指标的任务
- 待办事项历史
- 到期任务清单（铃铛清单）

## 4. 主要使用方式

### 4.1 新增基于时间的待办事项

1. 前往**功能** → 选择**待办事项清单**
2. 点击右下角的 **+** (FAB) 按钮
3. 选择**基于时间的待办事项**
4. 填写信息：
   - **任务名称**：（必填，例如："更换水过滤器"）
   - **重复周期**：输入数字并选择单位（日/周/月/年）
   - **下次到期日期**：选择日期（仅允许选择从明天开始）
   - **提醒时间**：选择时间（必填，例如：08:00）
   - **此任务会产生支出**：（可选）如有支出，请勾选
     - 如果勾选：选择**类别**（必填）
   - **备注**：附加信息（可选）
5. 点击**保存**

### 4.2 新增基于指标的待办事项

1. 前往**功能** → 选择**待办事项清单**
2. 点击 **+** (FAB) 按钮
3. 选择**基于指标的待办事项**
4. 填写信息：
   - **任务名称**：（必填，例如："更换汽车机油"）
   - **周期**：输入数字（例如：3,000）
   - **单位**：输入单位（例如："英里"）
   - **上次完成的指标值**：输入当前值（例如：12,500）
   - **此任务会产生支出**：（可选）如有支出，请勾选
     - 如果勾选：选择**类别**（必填）
   - **备注**：附加信息（可选）
5. 点击**保存**

### 4.3 确认基于指标的任务

1. 前往待办事项清单
2. 找到要确认的基于指标的任务（METRIC 类型）
3. 点击卡片中的**确认**按钮（仅在 `isActive = true` 时显示）
4. 填写信息：
   - **当前指标值**：输入当前值（必填，必须 ≥ 上次完成的指标值）
   - **备注**：（可选）
5. 查看自动计算的**增量**（当前值 - 上次完成值）
6. 点击**已确认**
7. （如果任务有支出）选择**添加支出**或**取消**

**注意**：基于时间的任务（CYCLE 类型）在卡片中没有"确认"按钮。确认仅在"到期任务"（铃铛清单）画面中进行。

### 4.4 查看清单和详细信息

1. 前往**功能** → 选择**待办事项清单**
2. 使用**搜索栏**依任务名称搜索
3. 使用**筛选芯片**筛选：
   - **全部**：显示所有任务
   - **基于时间**：仅显示 CYCLE 类型任务
   - **基于指标**：仅显示 METRIC 类型任务
4. 点击任务卡片查看详细信息和编辑

### 4.5 编辑待办事项

1. 前往待办事项清单
2. 点击任务卡片进行编辑
3. 更新信息：
   - **备注**：如果有历史记录，**周期**（CYCLE）或**单位/周期**（METRIC）将被锁定且无法编辑
4. 点击**保存**

### 4.6 查看历史

1. 前往待办事项清单
2. 点击任务的**查看历史 ›** 链接查看
3. 使用**筛选芯片**按时间筛选：
   - **全部**：显示所有历史
   - **本月**：仅显示当月历史
   - **上月**：仅显示上月历史
   - **最近 3 个月**：仅显示最近 3 个月的历史

### 4.7 停用/启用任务

1. 前往待办事项清单
2. 找到要停用/启用的任务
3. 切换卡片页脚中的**启用**开关
4. 已停用的任务将显示**"已停用"**标签（灰色）

### 4.8 删除待办事项

1. 前往待办事项清单
2. 点击卡片标题中的**删除**图标（🗑️）
3. 在对话框中确认删除
4. 任务及所有相关历史将被删除

## 5. 示例与用户界面图示

### TODO-01：创建基于时间的待办事项（更换水过滤器）

**目标**：创建基于时间的待办事项，以便应用程序在到期时自动提醒您。

**主要步骤**：
1. 前往功能 → 待办事项清单 → 点击"+"(FAB) 按钮
2. 选择"基于时间的待办事项"
3. 输入任务名称："更换水过滤器"
4. 输入周期："3" 个月
5. 选择下次到期日期：03/01/2026
6. 选择提醒时间：08:00
7. 勾选"此任务会产生支出"，选择类别"水电燃气费"
8. 输入备注："更换过滤器 #1 和 #2"
9. 点击"保存"

**线框图 - 新增基于时间的待办事项画面**：

```text
┌──────────────────────────────────────────────┐
│ <  新增基于时间的待办事项                    │
├──────────────────────────────────────────────┤

任务名称
[ 更换水过滤器                        ]

重复周期
每 [ 3 ] [ 月 ▼ ]
（单位：日 / 周 / 月 / 年）

下次到期日期
[ 03 / 01 / 2026    ▼ ]
提示：
首次到期日期。
后续日期将根据您输入的周期自动计算。

提醒时间
[ 08 : 00           ▼ ]

──────────────────────────────────────────────
[✓] 此任务会产生支出

┌─────────────────────────────────────┐
│ 类别 *                               │
│ [水电燃气费 ▼] [+ 创建新类别]       │
└─────────────────────────────────────┘

──────────────────────────────────────────────
备注（可选）
[                                          ]
[                                          ]
[                                          ]

──────────────────────────────────────────────
[ 取消 ]                         [ 保存 ]
└──────────────────────────────────────────────┘
```

---

### TODO-02：创建基于指标的待办事项（更换汽车机油）

**目标**：创建基于指标的待办事项以根据里程追踪汽车保养。

**主要步骤**：
1. 前往功能 → 待办事项清单 → 点击"+"(FAB) 按钮
2. 选择"基于指标的待办事项"
3. 输入任务名称："更换汽车机油"
4. 输入周期："3,000"，单位："英里"
5. 输入上次完成的指标值："12,500"
6. 勾选"此任务会产生支出"，选择类别"汽车保养"
7. 输入备注："更换机油 + 机油过滤器"
8. 点击"保存"

**线框图 - 新增基于指标的待办事项画面**：

```text
┌──────────────────────────────────────────────┐
│ <  新增基于指标的待办事项                    │
├──────────────────────────────────────────────┤

任务名称
[ 更换汽车机油                        ]

周期
每 [ 3,000 ] 单位 [ 英里 ]
（单位：英里 / 小时 / 次数 / ...）

上次完成的指标值
[ 12,500 ]

──────────────────────────────────────────────
[✓] 此任务会产生支出

┌─────────────────────────────────────┐
│ 类别 *                               │
│ [汽车保养 ▼] [+ 创建新类别]         │
└─────────────────────────────────────┘

──────────────────────────────────────────────
备注（可选）
[                                          ]
[                                          ]
[                                          ]

──────────────────────────────────────────────
[ 取消 ]                         [ 保存 ]
└──────────────────────────────────────────────┘
```

---

### TODO-03：查看清单和详细信息

**目标**：查看待办事项概览，按类型筛选，搜索，并查看每个任务的详细信息。

**主要步骤**：
1. 前往功能 → 待办事项清单
2. 查看带有搜索栏和筛选芯片的清单
3. 使用筛选："全部"、"基于时间"、"基于指标"
4. 使用搜索栏依任务名称搜索
5. 点击任务卡片查看详细信息

**线框图 - 待办事项清单画面**：

```text
┌─────────────────────────────────────────────────────────┐
│  [← 返回]  待办事项清单                        [🔔]        │
└─────────────────────────────────────────────────────────┘
│  🔍 搜索...                                             │
│                                                          │
│  [全部] [基于时间] [基于指标]                           │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 卡片：更换水过滤器                                  │    │
│  │ ┌─────────────────────────────────────────────┐ │    │
│  │ │ 更换水过滤器    [已完成] [🗑️]              │ │    │
│  │ │                                              │ │    │
│  │ │ 📅 周期：每 3 个月                           │ │    │
│  │ │ ✅ 上次完成：12/01/2025                      │ │    │
│  │ │ 📅 下次到期日期：03/01/2026                  │ │    │
│  │ │ ⏳ 剩余 76 天                                │ │    │
│  │ │ ───────────────────────────────────────────── │ │    │
│  │ │ 查看历史 ›                     [⚪ 启用中]    │ │    │
│  │ └─────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 卡片：更换汽车机油                                │    │
│  │ ┌─────────────────────────────────────────────┐ │    │
│  │ │ 更换汽车机油                   [🗑️]         │ │    │
│  │ │                                              │ │    │
│  │ │ 📏 追踪方式：英里                             │ │    │
│  │ │ ✅ 上次确认：12/02/2025                       │ │    │
│  │ │ 🔢 上次指标值：12,500 英里                    │ │    │
│  │ │ 🎯 下次到期：14,500 英里                      │ │    │
│  │ │ ⏳ ~300 英里剩余                              │ │    │
│  │ │ ───────────────────────────────────────────── │ │    │
│  │ │ [✓ 确认]                                      │ │    │
│  │ │ ───────────────────────────────────────────── │ │    │
│  │ │ 查看历史 ›                     [⚪ 启用中]    │ │    │
│  │ └─────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  [+ FAB]                                                 │
└─────────────────────────────────────────────────────────┘
```

---

### TODO-04：确认基于指标的任务（更换汽车机油）

**目标**：通过输入当前指标值确认基于指标的任务完成。

**主要步骤**：
1. 前往待办事项清单
2. 找到"更换汽车机油"任务（METRIC 类型）
3. 点击"确认"按钮
4. 输入当前指标值："14,520"
5. 查看自动计算的增量："+2,020 英里"
6. 输入备注："更换机油 + 机油过滤器"
7. 点击"已确认"

**线框图 - 确认基于指标的任务对话框**：

```text
┌──────────────────────────────────────────────┐
│  确认基于指标的任务                           │
├──────────────────────────────────────────────┤

任务名称：
更换汽车机油   （只读）

追踪方式：
英里   （只读）

上次完成的指标值：
12,500 英里   （只读）

──────────────────────────────────────────────
当前指标值
[ 14,520 ] 英里

增量：
+2,020 英里   （自动）

──────────────────────────────────────────────
备注
[                                          ]
[                                          ]
[                                          ]

──────────────────────────────────────────────
        [ 未确认 ]    [ 已确认 ]
└──────────────────────────────────────────────┘
```

---

### TODO-05：编辑待办事项并查看历史

**目标**：编辑待办事项信息并查看完成历史。

**主要步骤**：
1. 前往待办事项清单
2. 点击"更换水过滤器"任务卡片
3. 查看警告："⚠️ 周期已锁定，因为存在历史记录"（如果存在历史记录）
4. 编辑下次到期日期、提醒时间、备注
5. 点击"保存"
6. 点击"查看历史 ›"查看带筛选的历史

**线框图 - 待办事项历史画面**：

```text
┌─────────────────────────────────────────────────────────┐
│  [← 返回]  待办事项历史 - 更换水过滤器                    │
└─────────────────────────────────────────────────────────┘
│  [全部] [本月] [上月] [最近 3 个月]                      │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 更换水过滤器            [已完成]                  │    │
│  │                                                  │    │
│  │ 📅 周期：每 3 个月                                │    │
│  │ ✅ 完成于：12/01/2025 – 09:10                   │    │
│  │ 📝 备注：更换过滤器 #1 和 #2                     │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 更换水过滤器            [已完成]                  │    │
│  │                                                  │    │
│  │ 📅 周期：每 3 个月                                │    │
│  │ ✅ 完成于：09/01/2025 – 08:45                   │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

---

### TODO-06：停用和删除待办事项

**目标**：不再需要时停用或删除待办事项。

**主要步骤**：
1. 前往待办事项清单
2. 找到要停用的任务
3. 点击"启用"开关关闭
4. 查看"已停用"标签出现
5. 再次点击开关重新启用
6. 点击删除图标（🗑️）删除任务
7. 在对话框中确认删除

---

### TODO-07：确认基于指标的任务并添加支出

**目标**：确认基于指标的任务并自动添加相关支出。

**主要步骤**：
1. 前往待办事项清单
2. 找到"更换汽车机油"任务（METRIC 类型，hasCost = true）
3. 点击"确认"按钮
4. 输入当前指标值："14,520"
5. 输入备注："更换机油 + 机油过滤器"
6. 点击"已确认"
7. 查看"产生支出？"对话框自动打开
8. 点击"添加支出"
9. 查看"添加支出"画面，备注和类别已预先填入
10. 输入金额：350 CNY
11. 点击"保存"

**线框图 - 产生支出对话框**：

```text
┌──────────────────────────────────────────────┐
│  产生支出？                                   │
├──────────────────────────────────────────────┤
您想为此完成添加支出吗？

        [ 取消 ]         [ 添加支出 ]
└──────────────────────────────────────────────┘
```

## 6. 逻辑与规则

### 6.1 待办事项类型

- **基于时间（CYCLE 类型）**：
  - 按计划重复（日/周/月/年）
  - 到期时有提醒通知
  - 确认仅在"到期任务"（铃铛清单）画面中进行
  - 卡片中没有"确认"按钮

- **基于指标（METRIC 类型）**：
  - 基于指标里程碑重复（英里/小时/次数/其他）
  - 无通知（MVP1）
  - 卡片中有"确认"按钮（仅在 `isActive = true` 时显示）
  - 通过输入当前指标值确认

### 6.2 待办事项状态

- **待处理**：即将到来（尚未到期）
  - 不显示标签：`nextDueDate - today > 7 天`
  - 显示"即将到来"标签（黄色）：`0 < nextDueDate - today ≤ 7 天`
- **逾期**：逾期（红色）- `nextDueDate < today` 且未确认
- **未完成**：未完成（橙色）- 到期但未确认
- **已完成**：已完成（绿色）- 已确认
- **已取消**：已取消（灰色）- 此发生事件已取消
- **已停用**：已停用（灰色）- `isActive = false`

### 6.3 锁定周期/单位

- 如果存在历史记录（历史记录）：
  - **CYCLE 类型**：周期已锁定，无法编辑
  - **METRIC 类型**：单位和周期已锁定，无法编辑
- 显示警告："⚠️ 周期已锁定，因为存在历史记录"或"⚠️ 单位已锁定，因为存在历史记录"

### 6.4 确认基于指标的任务

- **验证**：
  - 当前指标值必须 ≥ 上次完成的指标值
  - 如果无效：显示错误"当前指标值必须 ≥ 上次完成的指标值"
- **自动更新**：
  - `lastMetricValue` = 当前值
  - `nextMetricValue` = 当前值 + 周期
  - `lastCompletedDate` = 今天
- **支出**：
  - 如果 `hasCost = true`：成功确认后显示"产生支出？"对话框
  - 导航到"添加支出"画面，带有 `initialNote`、`initialCategoryId`、`todoHistoryId`

### 6.5 通知

- **CYCLE 类型**：
  - 创建/编辑任务时安排通知
  - 停用或删除任务时取消通知
  - 重新启用时重新安排通知（如果 `nextDueDate >= today`）
- **METRIC 类型**：无通知（MVP1）

### 6.6 计算下次到期日期

- **CYCLE 类型**：
  - 确认后根据周期自动计算下次到期日期
  - 示例：周期 3 个月，到期日期 03/01/2026 → 确认后，下次到期日期 = 06/01/2026
- **METRIC 类型**：
  - 下次到期 = 当前值 + 周期
  - 示例：当前值 14,520 英里，周期 3,000 英里 → 下次到期 = 17,520 英里

## 7. 重要注意事项

1. **确认按钮**：
   - **基于时间的任务（CYCLE）**：卡片中没有"确认"按钮。确认仅在"到期任务"（铃铛清单）画面中进行。
   - **基于指标的任务（METRIC）**：卡片中有"确认"按钮（仅在 `isActive = true` 时显示）。

2. **铃铛图标**：标题中的铃铛图标导航到"到期任务"（铃铛清单）画面，用户可以在那里确认到期任务（仅适用于 CYCLE 类型）。

3. **锁定周期/单位**：如果存在历史记录，周期（CYCLE）或单位/周期（METRIC）将被锁定且无法编辑，以确保数据一致性。

4. **指标验证**：确认基于指标的任务时，当前指标值必须 ≥ 上次完成的指标值。如果不满足，应用程序将显示错误并阻止确认。

5. **产生支出**：如果任务有支出（`hasCost = true`），成功确认后，应用程序将询问您是否要添加支出。如果您选择"添加支出"，应用程序将自动预先填入备注和类别。

6. **删除任务**：删除任务时，所有相关历史也将被删除（级联删除）。通知也将被取消。

7. **停用**：停用 CYCLE 类型任务时，通知将被取消。重新启用时，通知将重新安排（如果 `nextDueDate >= today`）。

8. **高级访问**：此模块需要高级访问。如果您没有高级访问权限，应用程序将显示请求升级的对话框。

