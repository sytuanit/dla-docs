# やることリスト

## 1. 目的

**やることリスト**モジュールは、定期的なタスクを管理し、完了進捗を追跡するのに役立ちます：
- 時間ベースの定期的なタスク（日次/週次/月次/年次）
- 指標ベースの定期的なタスク（マイル/時間/回数...）
- 期日時のリマインド
- 完了履歴の追跡
- 支出の記録（該当する場合）

このモジュールは、車のメンテナンス、フィルター交換、定期点検などの重要なタスクを見逃さないようにします。

## 2. 使用するタイミング

以下の場合にこのモジュールを使用します：
- スケジュールに沿って繰り返すタスク（例：3ヶ月ごとに浄水器フィルターを交換）
- 指標に基づいて繰り返すタスク（例：3,000マイルごとに車のオイルを交換）
- 期日時に自動リマインドが必要
- 完了履歴を追跡したい
- 関連する支出を記録する必要がある

## 3. 関連画面

- やることリスト画面
- タスクタイプを選択（時間ベース / 指標ベース）
- 新しいやることの追加
- やることの編集
- 指標ベースのタスクを確認
- やることの履歴
- 期日タスクリスト（ベルリスト）

## 4. 主な使用方法

### 4.1 時間ベースのやることを追加

1. **機能** → **やることリスト**を選択
2. 右下の **+** (FAB) ボタンをタップ
3. **時間ベースのやること**を選択
4. 情報を入力：
   - **タスク名**: （必須、例：「浄水器フィルターを交換」）
   - **繰り返しサイクル**: 数値を入力し、単位を選択（日/週/月/年）
   - **次の期日**: 日付を選択（明日以降のみ選択可能）
   - **リマインド時間**: 時間を選択（必須、例：08:00）
   - **このタスクには支出が発生**: （任意）支出がある場合はチェック
     - チェックした場合: **カテゴリ**を選択（必須）
   - **メモ**: 追加情報（任意）
5. **保存**をタップ

### 4.2 指標ベースのやることを追加

1. **機能** → **やることリスト**を選択
2. **+** (FAB) ボタンをタップ
3. **指標ベースのやること**を選択
4. 情報を入力：
   - **タスク名**: （必須、例：「車のオイルを交換」）
   - **サイクル**: 数値を入力（例：3,000）
   - **単位**: 単位を入力（例：「マイル」）
   - **最後に完了した指標値**: 現在の値を入力（例：12,500）
   - **このタスクには支出が発生**: （任意）支出がある場合はチェック
     - チェックした場合: **カテゴリ**を選択（必須）
   - **メモ**: 追加情報（任意）
5. **保存**をタップ

### 4.3 指標ベースのタスクを確認

1. やることリストに移動
2. 確認する指標ベースのタスク（METRICタイプ）を探す
3. カードの**確認**ボタンをタップ（`isActive = true`の場合のみ表示）
4. 情報を入力：
   - **現在の指標値**: 現在の値を入力（必須、最後に完了した指標値以上である必要があります）
   - **メモ**: （任意）
5. **デルタ**が自動計算されるのを確認（現在の値 - 最後に完了した値）
6. **確認済み**をタップ
7. （タスクに支出がある場合）**支出を追加**または**キャンセル**を選択

**注意**: 時間ベースのタスク（CYCLEタイプ）には、カードに「確認」ボタンがありません。確認は「期日タスク」（ベルリスト）画面でのみ行われます。

### 4.4 リストと詳細を表示

1. **機能** → **やることリスト**を選択
2. **検索バー**を使用してタスク名で検索
3. **フィルタチップ**を使用してフィルタリング：
   - **すべて**: すべてのタスクを表示
   - **時間ベース**: CYCLEタイプのタスクのみ表示
   - **指標ベース**: METRICタイプのタスクのみ表示
4. タスクカードをタップして詳細を表示し、編集

### 4.5 やることを編集

1. やることリストに移動
2. 編集するタスクカードをタップ
3. 情報を更新：
   - **メモ**: 履歴がある場合、**サイクル**（CYCLE）または**単位/サイクル**（METRIC）はロックされ、編集できません
4. **保存**をタップ

### 4.6 履歴を表示

1. やることリストに移動
2. 表示するタスクの**履歴を表示 ›**リンクをタップ
3. **フィルタチップ**を使用して時間でフィルタリング：
   - **すべて**: すべての履歴を表示
   - **今月**: 今月の履歴のみ表示
   - **先月**: 先月の履歴のみ表示
   - **過去3ヶ月**: 過去3ヶ月の履歴のみ表示

### 4.7 タスクを無効化/有効化

1. やることリストに移動
2. 無効化/有効化するタスクを探す
3. カードフッターの**アクティブ**スイッチを切り替え
4. 無効化されたタスクは**「無効」**バッジ（グレー）を表示します

### 4.8 やることを削除

1. やることリストに移動
2. カードヘッダーの**削除**アイコン（🗑️）をタップ
3. ダイアログで削除を確認
4. タスクとすべての関連履歴が削除されます

## 5. 例とUI図解

### TODO-01: 時間ベースのやることを作成（浄水器フィルターを交換）

**目標**: 時間ベースのやることを作成して、期日時にアプリが自動的にリマインドします。

**主な手順**:
1. 機能 → やることリスト → "+" (FAB) ボタンをタップ
2. 「時間ベースのやること」を選択
3. タスク名を入力: 「浄水器フィルターを交換」
4. サイクルを入力: 「3」ヶ月
5. 次の期日を選択: 2026/03/01
6. リマインド時間を選択: 08:00
7. 「このタスクには支出が発生」にチェック、カテゴリ「光熱費」を選択
8. メモを入力: 「フィルター#1と#2を交換」
9. 「保存」をタップ

**ワイヤーフレーム - 時間ベースのやること追加画面**:

```text
┌──────────────────────────────────────────────┐
│ <  時間ベースのやることを追加                 │
├──────────────────────────────────────────────┤

タスク名
[ 浄水器フィルターを交換            ]

繰り返しサイクル
[ 3 ] ごとに [ 月 ▼ ]
（単位: 日 / 週 / 月 / 年）

次の期日
[ 2026 / 03 / 01    ▼ ]
ヒント: 
初回の期日。
以降の日付は、入力したサイクルに基づいて自動計算されます。

リマインド時間
[ 08 : 00           ▼ ]

──────────────────────────────────────────────
[✓] このタスクには支出が発生

┌─────────────────────────────────────┐
│ カテゴリ *                           │
│ [光熱費 ▼] [+ 新規作成]             │
└─────────────────────────────────────┘

──────────────────────────────────────────────
メモ（任意）
[                                          ]
[                                          ]
[                                          ]

──────────────────────────────────────────────
[ キャンセル ]                         [ 保存 ]
└──────────────────────────────────────────────┘
```

---

### TODO-02: 指標ベースのやることを作成（車のオイルを交換）

**目標**: 走行距離に基づいて車のメンテナンスを追跡するために指標ベースのやることを作成します。

**主な手順**:
1. 機能 → やることリスト → "+" (FAB) ボタンをタップ
2. 「指標ベースのやること」を選択
3. タスク名を入力: 「車のオイルを交換」
4. サイクルを入力: 「3,000」、単位: 「マイル」
5. 最後に完了した指標値を入力: 「12,500」
6. 「このタスクには支出が発生」にチェック、カテゴリ「車のメンテナンス」を選択
7. メモを入力: 「オイル + オイルフィルターを交換」
8. 「保存」をタップ

**ワイヤーフレーム - 指標ベースのやること追加画面**:

```text
┌──────────────────────────────────────────────┐
│ <  指標ベースのやることを追加                │
├──────────────────────────────────────────────┤

タスク名
[ 車のオイルを交換                        ]

サイクル
[ 3,000 ] ごとに 単位 [ マイル ]
（単位: マイル / 時間 / 回数 / ...）

最後に完了した指標値
[ 12,500 ]

──────────────────────────────────────────────
[✓] このタスクには支出が発生

┌─────────────────────────────────────┐
│ カテゴリ *                           │
│ [車のメンテナンス ▼] [+ 新規作成] │
└─────────────────────────────────────┘

──────────────────────────────────────────────
メモ（任意）
[                                          ]
[                                          ]
[                                          ]

──────────────────────────────────────────────
[ キャンセル ]                         [ 保存 ]
└──────────────────────────────────────────────┘
```

---

### TODO-03: リストと詳細を表示

**目標**: やることの概要を表示し、タイプでフィルタリングし、検索し、各タスクの詳細を表示します。

**主な手順**:
1. 機能 → やることリストに移動
2. 検索バーとフィルタチップ付きのリストを表示
3. フィルタを使用: 「すべて」、「時間ベース」、「指標ベース」
4. 検索バーを使用してタスク名で検索
5. タスクカードをタップして詳細を表示

**ワイヤーフレーム - やることリスト画面**:

```text
┌─────────────────────────────────────────────────────────┐
│  [← 戻る]  やることリスト                        [🔔]        │
└─────────────────────────────────────────────────────────┘
│  🔍 検索...                                             │
│                                                          │
│  [すべて] [時間ベース] [指標ベース]                     │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ カード: 浄水器フィルターを交換                      │    │
│  │ ┌─────────────────────────────────────────────┐ │    │
│  │ │ 浄水器フィルターを交換    [完了] [🗑️]       │ │    │
│  │ │                                              │ │    │
│  │ │ 📅 サイクル: 3ヶ月ごと                       │ │    │
│  │ │ ✅ 最後に完了: 2025/12/01                    │ │    │
│  │ │ 📅 次の期日: 2026/03/01                      │ │    │
│  │ │ ⏳ 残り76日                                   │ │    │
│  │ │ ───────────────────────────────────────────── │ │    │
│  │ │ 履歴を表示 ›                     [⚪ アクティブ]│ │    │
│  │ └─────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ カード: 車のオイルを交換                          │    │
│  │ ┌─────────────────────────────────────────────┐ │    │
│  │ │ 車のオイルを交換                   [🗑️]      │ │    │
│  │ │                                              │ │    │
│  │ │ 📏 追跡単位: マイル                           │ │    │
│  │ │ ✅ 最後に確認: 2025/12/02                    │ │    │
│  │ │ 🔢 最後の指標値: 12,500マイル                │ │    │
│  │ │ 🎯 次の期日: 14,500マイル                    │ │    │
│  │ │ ⏳ 残り約300マイル                            │ │    │
│  │ │ ───────────────────────────────────────────── │ │    │
│  │ │ [✓ 確認]                                      │ │    │
│  │ │ ───────────────────────────────────────────── │ │    │
│  │ │ 履歴を表示 ›                     [⚪ アクティブ]│ │    │
│  │ └─────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  [+ FAB]                                                 │
└─────────────────────────────────────────────────────────┘
```

---

### TODO-04: 指標ベースのタスクを確認（車のオイルを交換）

**目標**: 現在の指標値を入力して指標ベースのタスクの完了を確認します。

**主な手順**:
1. やることリストに移動
2. 「車のオイルを交換」タスク（METRICタイプ）を探す
3. 「確認」ボタンをタップ
4. 現在の指標値を入力: 「14,520」
5. 自動計算されたデルタを確認: 「+2,020マイル」
6. メモを入力: 「オイル + オイルフィルターを交換」
7. 「確認済み」をタップ

**ワイヤーフレーム - 指標ベースのタスク確認ダイアログ**:

```text
┌──────────────────────────────────────────────┐
│  指標ベースのタスクを確認                      │
├──────────────────────────────────────────────┤

タスク名:
車のオイルを交換   （読み取り専用）

追跡単位:
マイル   （読み取り専用）

最後に完了した指標値:
12,500マイル   （読み取り専用）

──────────────────────────────────────────────
現在の指標値
[ 14,520 ] マイル

デルタ:
+2,020マイル   （自動）

──────────────────────────────────────────────
メモ
[                                          ]
[                                          ]
[                                          ]

──────────────────────────────────────────────
        [ 未確認 ]    [ 確認済み ]
└──────────────────────────────────────────────┘
```

---

### TODO-05: やることを編集し、履歴を表示

**目標**: やることの情報を編集し、完了履歴を表示します。

**主な手順**:
1. やることリストに移動
2. 「浄水器フィルターを交換」タスクカードをタップ
3. 警告を確認: 「⚠️ 履歴があるためサイクルはロックされています」（履歴が存在する場合）
4. 次の期日、リマインド時間、メモを編集
5. 「保存」をタップ
6. 「履歴を表示 ›」をタップしてフィルタ付きの履歴を表示

**ワイヤーフレーム - やること履歴画面**:

```text
┌─────────────────────────────────────────────────────────┐
│  [← 戻る]  やること履歴 - 浄水器フィルターを交換          │
└─────────────────────────────────────────────────────────┘
│  [すべて] [今月] [先月] [過去3ヶ月]                      │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 浄水器フィルターを交換            [完了]          │    │
│  │                                                  │    │
│  │ 📅 サイクル: 3ヶ月ごと                           │    │
│  │ ✅ 完了日: 2025/12/01 – 09:10                 │    │
│  │ 📝 メモ: フィルター#1と#2を交換                  │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 浄水器フィルターを交換            [完了]          │    │
│  │                                                  │    │
│  │ 📅 サイクル: 3ヶ月ごと                           │    │
│  │ ✅ 完了日: 2025/09/01 – 08:45                 │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

---

### TODO-06: やることを無効化および削除

**目標**: 不要になったやることを無効化または削除します。

**主な手順**:
1. やることリストに移動
2. 無効化するタスクを探す
3. 「アクティブ」スイッチをタップしてオフにする
4. 「無効」バッジが表示されるのを確認
5. スイッチを再度タップして再有効化
6. 削除アイコン（🗑️）をタップしてタスクを削除
7. ダイアログで削除を確認

---

### TODO-07: 指標ベースのタスクを確認し、支出を追加

**目標**: 指標ベースのタスクを確認し、関連する支出を自動的に追加します。

**主な手順**:
1. やることリストに移動
2. 「車のオイルを交換」タスクを探す（METRICタイプ、hasCost = true）
3. 「確認」ボタンをタップ
4. 現在の指標値を入力: 「14,520」
5. メモを入力: 「オイル + オイルフィルターを交換」
6. 「確認済み」をタップ
7. 「支出が発生しましたか？」ダイアログが自動的に開くのを確認
8. 「支出を追加」をタップ
9. メモとカテゴリが事前入力された「支出を追加」画面を確認
10. 金額を入力: ¥5,000
11. 「保存」をタップ

**ワイヤーフレーム - 支出発生ダイアログ**:

```text
┌──────────────────────────────────────────────┐
│  支出が発生しましたか？                      │
├──────────────────────────────────────────────┤
この完了に対して支出を追加しますか？

        [ キャンセル ]         [ 支出を追加 ]
└──────────────────────────────────────────────┘
```

## 6. ロジックとルール

### 6.1 やることのタイプ

- **時間ベース（CYCLEタイプ）**:
  - スケジュールに沿って繰り返す（日/週/月/年）
  - 期日時にリマインド通知がある
  - 確認は「期日タスク」（ベルリスト）画面でのみ行われます
  - カードに「確認」ボタンがない

- **指標ベース（METRICタイプ）**:
  - 指標のマイルストーンに基づいて繰り返す（マイル/時間/回数/その他）
  - 通知なし（MVP1）
  - カードに「確認」ボタンがある（`isActive = true`の場合のみ表示）
  - 現在の指標値を入力して確認

### 6.2 やることのステータス

- **PENDING**: 近日中（まだ期日ではない）
  - バッジなし: `nextDueDate - today > 7日`
  - 「近日中」バッジ（黄色）を表示: `0 < nextDueDate - today ≤ 7日`
- **OVERDUE**: 期限切れ（赤） - `nextDueDate < today`で確認されていない
- **NOT_COMPLETED**: 未完了（オレンジ） - 期日だが確認されていない
- **COMPLETED**: 完了（緑） - 確認済み
- **CANCELLED**: キャンセル済み（グレー） - この発生がキャンセルされた
- **INACTIVE**: 無効（グレー） - `isActive = false`

### 6.3 サイクル/単位のロック

- 履歴がある場合（履歴レコード）：
  - **CYCLEタイプ**: サイクルがロックされ、編集できません
  - **METRICタイプ**: 単位とサイクルがロックされ、編集できません
- 警告を表示: 「⚠️ 履歴があるためサイクルはロックされています」または「⚠️ 履歴があるため単位はロックされています」

### 6.4 指標ベースのタスクを確認

- **検証**:
  - 現在の指標値は最後に完了した指標値以上である必要があります
  - 無効な場合: エラー「現在の指標値は最後に完了した指標値以上である必要があります」を表示
- **自動更新**:
  - `lastMetricValue` = 現在の値
  - `nextMetricValue` = 現在の値 + サイクル
  - `lastCompletedDate` = 今日
- **支出**:
  - `hasCost = true`の場合: 確認成功後に「支出が発生しましたか？」ダイアログを表示
  - `initialNote`、`initialCategoryId`、`todoHistoryId`で「支出を追加」画面に移動

### 6.5 通知

- **CYCLEタイプ**: 
  - タスクを作成/編集する際に通知がスケジュールされます
  - タスクを無効化または削除する際に通知がキャンセルされます
  - 再有効化する際に通知が再スケジュールされます（`nextDueDate >= today`の場合）
- **METRICタイプ**: 通知なし（MVP1）

### 6.6 次の期日を計算

- **CYCLEタイプ**: 
  - 確認後、サイクルに基づいて次の期日が自動計算されます
  - 例: サイクル3ヶ月、期日2026/03/01 → 確認後、次の期日 = 2026/06/01
- **METRICタイプ**: 
  - 次の期日 = 現在の値 + サイクル
  - 例: 現在の値14,520マイル、サイクル3,000マイル → 次の期日 = 17,520マイル

## 7. 重要な注意事項

1. **確認ボタン**:
   - **時間ベースのタスク（CYCLE）**: カードに「確認」ボタンがありません。確認は「期日タスク」（ベルリスト）画面でのみ行われます。
   - **指標ベースのタスク（METRIC）**: カードに「確認」ボタンがあります（`isActive = true`の場合のみ表示）。

2. **ベルアイコン**: ヘッダーのベルアイコンは「期日タスク」（ベルリスト）画面に移動し、ユーザーが期日タスクを確認できます（CYCLEタイプのみ）。

3. **サイクル/単位のロック**: 履歴がある場合、サイクル（CYCLE）または単位/サイクル（METRIC）がロックされ、データの一貫性を確保するために編集できません。

4. **指標の検証**: 指標ベースのタスクを確認する際、現在の指標値は最後に完了した指標値以上である必要があります。そうでない場合、アプリがエラーを表示し、確認を防ぎます。

5. **発生した支出**: タスクに支出がある場合（`hasCost = true`）、確認成功後、アプリが支出を追加するかどうかを尋ねます。「支出を追加」を選択した場合、アプリが自動的にメモとカテゴリを事前入力します。

6. **タスクの削除**: タスクを削除する際、すべての関連履歴も削除されます（カスケード削除）。通知もキャンセルされます。

7. **無効化**: CYCLEタイプのタスクを無効化する際、通知がキャンセルされます。再有効化する際、通知が再スケジュールされます（`nextDueDate >= today`の場合）。

8. **プレミアムアクセス**: このモジュールにはプレミアムアクセスが必要です。プレミアムがない場合、アプリがアップグレードを要求するダイアログを表示します。

