# 貯蓄

## 1. 目的

**貯蓄**モジュールは、銀行の貯蓄口座を管理し、残高、金利、期間を追跡するのに役立ちます。このモジュールは以下をサポートします：
- 複数の貯蓄口座の管理
- 金利と期間の追跡
- 満期時の利息の自動計算
- 早期引き出し（必要な場合）
- 口座の継続

## 2. 使用するタイミング

以下の場合にこのモジュールを使用します：
- 銀行の貯蓄口座がある
- 残高と金利を追跡する必要がある
- 満期時のリマインドを希望
- 複数の貯蓄口座を管理する必要がある

## 3. 関連画面

- 貯蓄口座リスト
- 新しい口座の追加
- 口座の編集
- 口座詳細
- 早期引き出し

## 4. 主な使用方法

### 4.1 新しい貯蓄口座を作成

1. **機能** → **銀行貯蓄**を選択
2. 右下の **+** (FAB) ボタンをタップ
3. 「現在の残高」を確認（クリックして詳細を表示可能）
4. 銀行を選択：
   - 存在する場合: ドロップダウンから選択
   - 存在しない場合: "+"ボタンをタップして新しい銀行を作成
5. 預金額を入力（現在の残高以下である必要があります）
6. 期間を入力: 1-36ヶ月
7. 金利を入力: %/年（1-100%）
8. 開始日を選択（デフォルトは今日、前月の初めから現在まで選択可能）
9. 満期日が自動計算されるのを確認（開始日 + 期間）
10. 満期時の計画を選択：
    - 元本と利息を引き出す（デフォルト）
    - 元本を継続（利息は口座に）
    - 元本 + 利息を継続
11. （任意）メモを入力
12. （任意）通知時間を選択（デフォルト: 10:00と19:00）
13. **口座を作成**をタップ

### 4.2 リストと口座詳細を表示

1. **機能** → **銀行貯蓄**を選択
2. デフォルトフィルタ「アクティブ」で「貯蓄口座リスト」画面を表示
3. 概要カードを確認：
   - フィルタ「アクティブ」: 現在の残高、貯蓄額、予想利息、今月の利息
   - フィルタ「完了」: 総引き出し額、受領利息
4. （任意）検索バーを使用して銀行名またはコードで口座を検索
5. フィルタを「アクティブ」と「完了」の間で切り替え
6. 貯蓄口座をタップして詳細を表示：
   - 口座情報: 銀行、期間、金利、預金額、予想利息
   - 開始日と満期日
   - ステータス: アクティブ
   - 満期時の計画
   - （存在する場合）継続履歴
   - 「引き出し」ボタン（アクティブの場合）

### 4.3 貯蓄口座を引き出す

1. 貯蓄リストに移動し、満期日に達したまたは過ぎた口座を探す
2. カードの**引き出し**ボタンをタップ（または詳細に移動して「引き出し」をタップ）
3. 「貯蓄口座を引き出す」ダイアログを確認：
   - 口座情報: 銀行、預金額、期間、金利
   - 引き出し日（デフォルト = 満期日、異なる日付を選択可能）
   - 受領利息（デフォルト = 予想利息、編集可能）
   - 総受領額（自動計算 = 元本 + 利息）
4. （任意）引き出し日または受領利息を編集
5. **確認**をタップ

### 4.4 貯蓄口座を継続

1. 貯蓄リストに移動し、計画「元本を継続」または「元本 + 利息を継続」で満期日に達した口座を探す
2. **継続**ボタンまたは「計画通りに継続」をタップ
3. 「貯蓄口座を継続」ダイアログを確認：
   - 口座情報: 銀行、元本額、期間、金利
   - 受領利息（元本を継続する場合、利息は口座に入ります）
4. （任意）新しい金利または新しい期間を編集（デフォルト = 古い期間）
5. **継続を確認**をタップ

### 4.5 貯蓄口座を編集

1. アクティブな貯蓄口座の詳細に移動
2. 右上の**編集**ボタンをタップ
3. 情報を編集：
   - 銀行（必要な場合）
   - 預金額（増加する場合、現在の残高以下である必要があります）
   - 期間、金利
   - 開始日（必要な場合）
   - 満期時の計画
   - メモ、通知時間
4. 満期日が自動再計算されるのを確認（期間/開始日が変更された場合）
5. **変更を保存**をタップ

### 4.6 新しい銀行を作成

1. 「貯蓄口座を追加」または「貯蓄口座を編集」画面で
2. 「銀行」フィールドをタップ
3. ドロップダウンの横の"+"ボタンをタップして新しい銀行を作成
4. 「新しい銀行を追加」ダイアログを確認
5. 銀行名を入力
6. 銀行コードを入力（最大3-4文字、自動大文字）
7. アイコン色を選択（カラーピッカーまたはパレットから）
8. アイコンプレビューを確認
9. **作成**をタップ

## 5. 例とUI図解

### SAVINGS-01: 新しい貯蓄口座を作成

**目標**: 銀行預金、金利、満期日を追跡するために新しい貯蓄口座を作成します。

**主な手順**:
1. 機能 → 銀行貯蓄に移動
2. "+" (FAB) ボタンをタップ
3. 銀行を選択（または新規作成）
4. 預金額、期間、金利を入力
5. 開始日を選択（デフォルトは今日）
6. 満期時の計画を選択
7. （任意）メモと通知時間を入力
8. 「口座を作成」をタップ

**ワイヤーフレーム - 貯蓄口座追加画面**:

```text
┌──────────────────────────────────────────────┐
│ <  貯蓄口座を追加                             │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│ [ カード ]                                    │
│                                               │
│ 現在の残高                      [ > ]        │
│ ¥208,000                                      │
│                                               │
│ 銀行 *                                         │
│ [ 三菱UFJ銀行 ▼ ]                      [ + ] │
│                                               │
│ 預金額 (JPY) *                                 │
│ [ ¥400,000 ]                                  │
│                                               │
│ 期間 *                                         │
│ [ 6 ] ヶ月                                     │
│                                               │
│ 金利 *                                         │
│ [ 4.8 ] %/年                                   │
│                                               │
│ 開始日 *                                       │
│ [ 2025/12/20 ]                    [📅]        │
│                                               │
│ 満期日（読み取り専用）                        │
│ [ 2026/06/20 ]                                 │
│                                               │
│ 満期時の計画                                   │
│ (●) 元本と利息を引き出す                      │
│ ( ) 元本を継続                                 │
│ ( ) 元本 + 利息を継続                         │
│                                               │
│ メモ（任意）                                   │
│ [                                      ]      │
│                                               │
│ 通知時間1                                      │
│ [ 10:00 ]                          [🕐]       │
│                                               │
│ 通知時間2                                      │
│ [ 19:00 ]                          [🕐]       │
└──────────────────────────────────────────────┘

        [  キャンセル  ]       [  口座を作成  ]
```

---

### SAVINGS-02: 貯蓄口座を引き出す

**目標**: 満期日に達したときに貯蓄口座を引き出して、元本と利息を受領します。

**主な手順**:
1. 貯蓄リストに移動し、満期日に達したまたは過ぎた口座を探す
2. 「引き出し」ボタンをタップ
3. 口座情報、引き出し日、受領利息を含むダイアログを確認
4. （任意）引き出し日または受領利息を編集
5. 「確認」をタップ

**ワイヤーフレーム - 引き出しダイアログ**:

```text
┌─────────────────────────────────────────┐
│  貯蓄口座を引き出す                      │
├─────────────────────────────────────────┤
│  [アイコン 銀行]  三菱UFJ銀行            │
│                                         │
│  期間と金利: 6ヶ月 · 4.8%/年            │
│  預金額: ¥400,000                       │
│                                         │
│  引き出し日:                            │
│  [ 2025 / 12 / 20 ]  [📅]               │
│                                         │
│  受領利息:                              │
│  [ ¥9,600 ]                             │
│                                         │
│  総受領額: ¥409,600                     │
│                                         │
│  [  確認  ]                              │
└─────────────────────────────────────────┘
```

---

### SAVINGS-03: リストと口座詳細を表示

**目標**: アクティブおよび完了した貯蓄口座の概要、および各口座の詳細を表示します。

**主な手順**:
1. 機能 → 銀行貯蓄に移動
2. フィルタ別の概要カードを確認
3. 検索バーを使用（任意）
4. フィルタを「アクティブ」と「完了」の間で切り替え
5. 口座をタップして詳細を表示

**ワイヤーフレーム - リスト画面**:

```text
┌──────────────────────────────────────────────┐
│ <  銀行貯蓄管理                               │
│                  [ + [FAB] 口座を追加 ]      │
└──────────────────────────────────────────────┘

[チップ] フィルタ
[ アクティブ ]   [ 完了 ]

┌──────────────────────────────────────────────┐
│  概要カード                                   │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ 現在の        │  │ 予想          │         │
│  │ 残高          │  │ 利息          │         │
│  │ ¥208,000      │  │ ¥21,900       │         │
│  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐         │
│  │ 貯蓄額        │  │ 今月の        │         │
│  │              │  │ 利息          │         │
│  │ ¥1,400,000   │  │ ¥7,600        │         │
│  └──────────────┘  └──────────────┘         │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│  🔍 検索バー                                  │
│  [ 🔍 検索... ]                               │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│ [アイコン 銀行] 三菱UFJ銀行      [アイコン 削除] │
│                                              │
│ ¥400,000         |  6ヶ月 @ 4.8%            │
│                                              │
│ 予想利息: ¥9,600                             │
│ 満期: 2025/12/20   （残り5日）              │
│                    🔔 間もなく満期           │
│                                              │
│                    [ 引き出し ]             │
└──────────────────────────────────────────────┘
```

**ワイヤーフレーム - 詳細画面**:

```text
┌──────────────────────────────────────────────┐
│ [アイコン 銀行]  三菱UFJ銀行          [ 編集 ]│
│                                              │
│ 期間と金利: 6ヶ月 · 4.8%/年                  │
│ 預金額: ¥400,000                             │
│ 予想利息: ¥9,600                             │
│                                              │
│ 開始日: 2025/06/20                           │
│ 満期日: （残り5日） 2025/12/20               │
│                                              │
│ ステータス: アクティブ                        │
│                                              │
│ 満期時の計画:                                │
│ (●) 元本と利息を引き出す                     │
│                                              │
│                    [  引き出し  ]           │
└──────────────────────────────────────────────┘
```

---

### SAVINGS-04: 貯蓄口座を継続

**目標**: 満期日に達したときに計画通りに貯蓄口座を継続します。

**主な手順**:
1. 計画「元本を継続」または「元本 + 利息を継続」で満期日に達した口座を探す
2. 「継続」ボタンをタップ
3. 口座情報と受領利息を含むダイアログを確認
4. （任意）新しい金利または新しい期間を編集
5. 「継続を確認」をタップ

**結果**: 古い口座が更新され、古い口座にリンクされたrootSavingIdで新しい口座が作成されます。元本を継続する場合、利息が現在の残高に追加されます。元本 + 利息を継続する場合、元本と利息の両方が継続され、現在の残高は変更されません。

---

### SAVINGS-05: 新しい銀行を作成

**目標**: 貯蓄口座を作成する際に使用する新しい銀行を作成します。

**主な手順**:
1. 「貯蓄口座を追加」または「貯蓄口座を編集」画面で
2. 「銀行」ドロップダウンの横の"+"ボタンをタップ
3. 銀行名、銀行コードを入力
4. アイコン色を選択
5. アイコンプレビューを確認
6. 「作成」をタップ

**ワイヤーフレーム - 銀行作成ダイアログ**:

```text
┌─────────────────────────────────────────┐
│  新しい銀行を追加                         │
├─────────────────────────────────────────┤
│  銀行名                                   │
│  [ ABC銀行 ]                              │
│                                         │
│  銀行コード                               │
│  [ ABC ]                                 │
│                                         │
│  アイコン色                               │
│  [ 🎨 ]  #FF5722                         │
│                                         │
│  アイコンプレビュー                       │
│  ┌─────────┐                             │
│  │   ABC   │  （背景: #FF5722）          │
│  └─────────┘                             │
│                                         │
│  [  キャンセル  ]    [  作成  ]         │
└─────────────────────────────────────────┘
```

---

### SAVINGS-06: 貯蓄口座を編集

**目標**: アクティブな貯蓄口座の情報（銀行、金額、期間、金利、満期計画）を編集します。

**主な手順**:
1. アクティブな貯蓄口座の詳細に移動
2. 「編集」ボタンをタップ
3. 必要な情報を編集
4. 満期日が自動再計算されるのを確認（期間/開始日が変更された場合）
5. 「変更を保存」をタップ

**結果**: 口座情報が更新され、新しい金利に基づいて予想利息が再計算されます。金額が変更された場合、現在の残高がそれに応じて調整されます。

## 6. ロジックとルール

### 6.1 利息計算

- 利息は次の式で計算されます: `金額 × 金利 × (期間 / 12)`
- 利息は満期時または早期引き出し時に計算されます

### 6.2 ステータス

- **アクティブ (ACTIVE)**: 貯蓄口座がアクティブで、満期日に達していない、または処理されていない
- **完了 (COMPLETED)**: 口座が引き出された
- **継続済み (ROLLED_OVER)**: 口座が継続され、新しい口座が作成された

### 6.3 引き出しと継続

- **引き出し**: 引き出す際、元本 + 利息が現在の残高に追加され、「貯蓄利息」カテゴリで「臨時収入」が自動的に作成されます
- **早期引き出し**: 満期日前に引き出すことができ、受領利息は予想利息より低い場合があります
- **元本を継続**: 利息が現在の残高に追加され、元本が新しい期間で継続されます
- **元本 + 利息を継続**: 元本と利息の両方が継続され、現在の残高は変更されません
- **継続履歴**: 継続は保存され、口座詳細に表示され、`rootSavingId`を介してリンクされます

### 6.4 通知

- 満期日になると、アプリがリマインド通知を送信します
- 各口座の通知時間を設定できます（`notificationTime1`、`notificationTime2`、デフォルト10:00と19:00）

## 7. 重要な注意事項

- **プレミアムモジュール必須**: この機能はプレミアムユーザーのみ利用可能
- **金利**: 年間金利を入力（%/年）、1%から100%
- **期間**: 月単位で計算、1ヶ月から36ヶ月
- **満期日**: 開始日 + 期間から自動計算
- **預金額**: 現在の残高以下である必要があり、口座作成時に現在の残高から自動的に差し引かれます
- **開始日**: 前月の初めから現在までのみ選択可能
- **通知**: 通知は満期日に2回（デフォルト10:00と19:00）送信され、各口座でカスタマイズ可能
- **バッジ「間もなく満期」**: 満期日まで≤7日のときに表示
- **バッジ「満期」**: 満期日が到来したときに表示
- **口座の削除**: アクティブな口座を削除する際、元本額が現在の残高に追加されます。ルート口座を削除すると、継続チェーン全体が削除されます
- **概要カード**: フィルタによって変更され、アクティブまたは完了した口座の集約情報を表示します

