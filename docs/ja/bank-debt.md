# 銀行ローン

## 1. 目的

**銀行ローン**モジュールは、銀行ローンを管理するのに役立ちます：
- ローン額、金利、期間を追跡
- 返済スケジュールを管理
- 期間ごとの利息を計算（該当する場合）
- 延滞ペナルティを管理
- 早期返済（必要な場合）

## 2. 使用するタイミング

以下の場合にこのモジュールを使用します：
- 銀行ローンがある
- 返済スケジュールを追跡する必要がある
- 利息とペナルティを計算したい
- 返済期日にリマインドが必要

## 3. 関連画面

- ローンリスト
- 新しいローンの追加（4ステップ）
- ローンの編集
- ローン詳細と返済スケジュール
- 早期返済

## 4. 主な使用方法

### 4.1 新しいローンを追加（4ステップ）

#### ステップ1: 基本情報

1. **機能** → **銀行ローン**を選択
2. **+** (FAB) ボタンをタップ
3. 情報を入力：
   - **銀行**: 銀行を選択または新規作成
   - **ローン名**: （例：「住宅ローン」）
   - **ローン額**: 元本額
   - **融資実行日**: お金を受領した日付
   - **期間**: 年数
   - **金利タイプ**: 優遇/変動金利または固定金利
4. **次へ**をタップ

#### ステップ2: 金利を設定

**「優遇/変動金利」を選択した場合：**
- **優遇金利あり**を有効化（該当する場合）
- **優遇期間**と**優遇金利**を入力
- 変動金利期間を追加：
  - 年と月の範囲を選択
  - 金利（%/年）を入力
  - **変動**または**固定**を選択

**「固定金利」を選択した場合：**
- **固定金利**（%/年）を入力

**次へ**をタップ

#### ステップ3: ペナルティを設定

1. **延滞ペナルティあり**を有効化（該当する場合）
2. ペナルティ期間を追加：
   - 年と月の範囲を選択
   - **ペナルティ率**（%/年）を入力
3. **次へ**をタップ

#### ステップ4: 確認して保存

1. 情報を確認：
   - 支払い総額
   - 予想返済スケジュール
2. **保存**をタップ

### 4.2 ローン詳細を表示

1. ローンリストに移動
2. ローンをタップ
3. 情報を確認：
   - 基本情報
   - 返済スケジュール
   - 支払済み額 / 残額
   - 金利とペナルティ

### 4.3 返済期間を支払済みとしてマーク

1. ローン詳細に移動
2. 期日の返済期間（バッジ「未払い」）を探す
3. **支払済みとしてマーク**をタップ
4. 情報を入力：
   - **実際の支払い日**: 支払った日付（デフォルト = 今日）
   - **実際に支払った利息**: 実際に支払った利息（デフォルト = 予定利息）
   - **メモ**: （任意）
5. **実際の支払い総額**が自動計算されるのを確認（元本 + 実際の利息）
6. **確認**をタップ

### 4.4 現在の金利を更新

1. ローン詳細に移動（現在変動金利期間の場合のみ表示）
2. **現在の金利を更新**をタップ
3. 情報を入力：
   - **新しい金利**: 新しい金利（%/年）
   - **適用開始日**: 新しい金利を適用開始する日付（デフォルト = 現在の期間の開始）
   - **メモ**: （任意）
4. **保存**をタップ
5. 現在の期間以降の未払い期間が新しい金利で更新されます

### 4.5 早期返済

1. ローン詳細に移動
2. **返済額を計算**をタップ
3. **ステップ1 - 前払い情報を入力：**
   - 方法を選択: **一部返済**または**全額返済**
   - 前払い日を選択（デフォルト = 今日）
   - 前払い額を入力（一部返済の場合）
   - **早期返済ペナルティ**が自動計算されるのを確認
4. **次へ**をタップ
5. **ステップ2 - オプションを比較：**
   - 「前払いなし」と「前払い」の比較を確認
   - 結果を確認: 利息の節約、期間の短縮
6. **前払いを確認**をタップ

### 4.6 ローンを編集

1. ローン詳細に移動
2. **編集**をタップ（名前、メモ、銀行のみ編集可能）
3. 編集可能な情報を編集：
   - **ローン名**: 編集可能
   - **銀行**: 変更可能
   - **メモ**: 編集可能
   - **ローン額、融資実行日、期間、金利**: 支払いがまだ行われていない場合のみ編集可能
4. **保存**をタップ

## 5. 例とUI図解

### LOAN-01: 新しいローンを作成（優遇金利付き住宅ローン）

**目標**: 住宅ローン、優遇金利、月次返済スケジュールを追跡するために新しいローンを作成します。

**手順**:
1. **機能** → **銀行ローン**を選択
2. **+** (FAB) ボタンをタップして新しいローンを追加
3. **ステップ1 - 基本情報：**
   - 銀行を選択: 三菱UFJ銀行
   - 名前を入力: 「住宅ローン - 都心のアパート」
   - ローン額を入力: ¥20,000,000
   - 融資実行日を選択: 2023/04/01
   - 期間を入力: 10年（自動計算 = 120期間）
   - 通知時間を選択: 10:00と19:00
   - 金利タイプを選択: 「元利均等返済」
   - **次へ**をタップ
4. **ステップ2 - 金利を設定：**
   - 「優遇金利期間あり」を有効化
   - 入力: 最初の6ヶ月 @ 6.0%/年
   - 以降の期間を追加：
     - 1年目（7-12ヶ月）: 9.0%/年、変動
     - 2年目（13-24ヶ月）: 9.5%/年、変動
     - 3年目以降: 10.0%/年、変動
   - **次へ**をタップ
5. **ステップ3 - 早期返済ペナルティを設定：**
   - 「早期返済ペナルティを適用」を有効化
   - ペナルティを入力: 1-3年目: 2.0%、4-5年目: 1.5%、6年目以降: 1.0%
   - **次へ**をタップ
6. **ステップ4 - 確認：**
   - 要約情報を確認
   - **ローンを作成**をタップ

**結果**: ローンが正常に作成され、120期間の返済スケジュールが自動的に作成され、通知がスケジュールされます。

**ワイヤーフレーム - ステップ1: 基本情報**

```text
┌─────────────────────────────────────────┐
│ <  ローンを追加                          │
├─────────────────────────────────────────┤
│ ローン名 *                                │
│ [住宅ローン - 都心のアパート]            │
│                                          │
│ 銀行 *                                    │
│ [三菱UFJ銀行 ▼] [+ 新規作成]             │
│                                          │
│ ローン額 *                                │
│ [¥20,000,000]                            │
│                                          │
│ 融資実行日 *                              │
│ [2023/04/01] [📅]                        │
│                                          │
│ ローン期間（年） *                        │
│ [10] 年                                  │
│ ヒント: アプリが自動計算 = 120期間       │
│                                          │
│ 通知時間1 *                               │
│ [10:00] [🕐]                             │
│                                          │
│ 通知時間2 *                               │
│ [19:00] [🕐]                             │
│                                          │
│ 金利タイプ *                              │
│ ● 元利均等返済                            │
│ ○ 全期間固定金利                          │
│                                          │
│ [次へ] [キャンセル]                      │
└─────────────────────────────────────────┘
```

---

### LOAN-02: ローンリストと詳細を表示

**目標**: ローンの概要を表示し、ステータスでフィルタリングし、検索し、各ローンの詳細を表示します。

**手順**:
1. **機能** → **銀行ローン**を選択
2. フィルタ「アクティブ」（デフォルト）と「完了」でリスト画面を表示
3. フィルタを切り替えて異なる概要を確認
4. 検索バーを使用: 「都心」を入力
5. ローンをタップして詳細を表示
6. 支払済み期間、現在の期間、将来の期間を含む返済スケジュールを確認
7. 返済スケジュールの検索バーを使用: 「2024/9」を入力

**結果**: リストがフィルタごとに正しく表示され、ローン詳細が完全な情報と返済スケジュールを表示します。

**ワイヤーフレーム - ローンリスト**

```text
┌─────────────────────────────────────────┐
│ <  銀行ローン管理                        │
├─────────────────────────────────────────┤
│ [アクティブ] [完了]                      │
│                                          │
│ ┌─────────────────────────────────────┐  │
│ │ 現在の残高: ¥16,450,000            │  │
│ │ 総元本ローン: ¥20,000,000          │  │
│ │ 支払った利息: ¥172,000              │  │
│ │ アクティブ: 1ローン                  │  │
│ └─────────────────────────────────────┘  │
│                                          │
│ [🔍 検索（ローン名、銀行）]              │
│                                          │
│ ┌─────────────────────────────────────┐  │
│ │ [アイコン] 三菱UFJ銀行  [アクティブ] │  │
│ │ 住宅ローン - 都心のアパート          │  │
│ │ 残高: ¥16,450,000                    │  │
│ │ 元本: ¥20,000,000                    │  │
│ │ 進捗: 8 / 120期間                    │  │
│ │ 終了日: 2033/04/01                   │  │
│ └─────────────────────────────────────┘  │
│                                          │
│                                    [+]   │
└─────────────────────────────────────────┘
```

**ワイヤーフレーム - ローン詳細**

```text
┌─────────────────────────────────────────┐
│ <  ローン詳細                            │
├─────────────────────────────────────────┤
│ [アイコン] 三菱UFJ銀行          [編集]  │
│ 住宅ローン - 都心のアパート               │
│ [アクティブ]                              │
│                                          │
│ 元本ローン: ¥20,000,000                  │
│ 現在の残高: ¥16,450,000                  │
│ 支払済み期間: 8 / 120                    │
│ 支払った利息: ¥172,000                   │
│ 現在の金利: 9.0%/年                      │
│                                          │
│ [金利を更新] [返済額を計算]              │
│                                          │
│ 返済スケジュール                          │
│ [🔍 期間を検索（例：「2025/5」）]        │
│                                          │
│ 期間1 – 2023/05 [支払済み]               │
│ 合計: ¥215,000 • 元本: ¥100,000 • 利息: ¥115,000│
│                                          │
│ 期間9 – 2024/01 [未払い]                 │
│ 元本: ¥100,000                           │
│ 利息: ¥115,000                           │
│ 合計: ¥215,000                           │
│ 期日: 2024/01/15                         │
│ [支払済みとしてマーク]                   │
│                                          │
│ 期間10 – 2024/02 [期日前]                │
│ 合計: ¥215,000 • 元本: ¥100,000 • 利息: ¥115,000│
└─────────────────────────────────────────┘
```

---

### LOAN-03: 返済期間を支払済みとしてマーク（支払いを記録）

**目標**: 銀行に支払いを行った後、返済期間を「支払済み」としてマークします。

**手順**:
1. ローン詳細に移動
2. バッジ「未払い」が付いた現在の期間（期間9）を探す
3. **支払済みとしてマーク**をタップ
4. 情報を入力：
   - 実際の支払い日: 2024/01/15（デフォルト = 今日）
   - 実際に支払った利息: ¥115,000（デフォルト = 予定利息）
   - メモ: （任意）
5. 実際の支払い総額が自動計算されるのを確認
6. **確認**をタップ

**結果**: 期間9が「支払済み」に更新され、残高が減少し、支払済み期間が増加し、現在の残高が減少します。

**ワイヤーフレーム - 支払済みとしてマークダイアログ**

```text
┌─────────────────────────────────────────┐
│ 支払済みとしてマーク                      │
├─────────────────────────────────────────┤
│ 期間9 – 2024/01          [未払い]        │
│                                          │
│ 期日（予定）: 2024/01/15                 │
│ 元本（固定）: ¥100,000                   │
│                                          │
│ 実際の支払い日 *                          │
│ [2024/01/15] [📅]                        │
│                                          │
│ 実際に支払った利息 *                      │
│ [¥115,000]                               │
│ ヒント: 予定利息: ¥115,000               │
│                                          │
│ 実際の支払い総額 =                        │
│   ¥100,000 (元本)                        │
│ + ¥115,000 (実際の利息)                  │
│ ────────────────────────────────        │
│ = ¥215,000                               │
│                                          │
│ メモ（任意）                              │
│ [¥50少なく支払い、利息削減を受けました...]│
│                                          │
│ [キャンセル] [確認]                      │
└─────────────────────────────────────────┘
```

---

### LOAN-04: 現在の金利を更新（銀行が変動金利を調整した場合）

**目標**: 銀行が変動金利の調整を発表したときに新しい金利を更新します。

**手順**:
1. ローン詳細に移動
2. 「現在の金利: 9.0%/年」を確認
3. **現在の金利を更新**をタップ（現在変動金利期間の場合のみ表示）
4. 情報を入力：
   - 新しい金利: 10.5%/年
   - 適用開始日: 2024/01/15（デフォルト = 現在の期間の開始）
   - メモ: 「銀行が新しい決定に基づいて金利を調整」
5. **保存**をタップ

**結果**: 現在の金利が更新され、現在の期間以降の未払い期間が新しい金利で更新されます。

**ワイヤーフレーム - 金利更新ダイアログ**

```text
┌─────────────────────────────────────────┐
│ 現在の金利を更新                          │
├─────────────────────────────────────────┤
│ [アイコン] 三菱UFJ銀行                   │
│ ローン名: 住宅ローン - 都心のアパート    │
│ 現在の期間: 期間9 – 2024/01              │
│ ステータス: [アクティブ]                  │
│ 期間: 変動（優遇後）                      │
│                                          │
│ 現在の金利（適用中）:                    │
│ [9.0] %/年（読み取り専用）                │
│                                          │
│ 新しい金利（%/年） *                      │
│ [10.5] %/年                              │
│                                          │
│ 適用開始日 *                              │
│ [2024/01/15] [📅]                        │
│                                          │
│ メモ（任意）                              │
│ [銀行が金利を調整...]                     │
│                                          │
│ • 新しい金利は現在の期間以降の期間に適用されます。│
│ • 以前に支払った期間は変更されません。    │
│                                          │
│ [キャンセル] [保存]                      │
└─────────────────────────────────────────┘
```

---

### LOAN-05: 早期返済（一部返済で利息を削減）

**目標**: ローンを早期に一部返済して、支払い総利息を削減し、ローン期間を短縮します。

**手順**:
1. ローン詳細に移動
2. **返済額を計算**をタップ
3. **ステップ1 - 前払い情報を入力：**
   - 方法を選択: 「一部返済」
   - 前払い日を選択: 2024/01/15
   - 前払い額を入力: ¥8,000,000
   - ペナルティが自動計算されるのを確認: ¥160,000（2.0%）
   - **次へ**をタップ
4. **ステップ2 - オプションを比較：**
   - 「前払いなし」と「前払い¥8,000,000」の比較を確認
   - 結果を確認: 利息を¥3,000,000節約、40期間削減
   - **前払いを確認**をタップ

**結果**: 残高が減少し、返済スケジュールが再計算され、期間数が減少し、終了日が早くなります。

**ワイヤーフレーム - ステップ1: 前払い情報を入力**

```text
┌─────────────────────────────────────────┐
│ <  早期返済                              │
├─────────────────────────────────────────┤
│ [アイコン] 三菱UFJ銀行                   │
│ ローン名: 住宅ローン - 都心のアパート    │
│ 現在の残高: ¥20,000,000                  │
│ 現在の期間: 期間9 – 2024/01              │
│                                          │
│ どのように返済しますか？                │
│ ● 一部返済                               │
│ ○ 全額返済                               │
│                                          │
│ 前払い日 *                                │
│ [2024/01/15] [📅]                        │
│                                          │
│ 前払い額 *                                │
│ [¥8,000,000]                             │
│                                          │
│ 適用されるペナルティ率: 2.0%             │
│ ペナルティ: ¥160,000                     │
│                                          │
│ [次へ]                                   │
└─────────────────────────────────────────┘
```

**ワイヤーフレーム - ステップ2: オプションを比較**

```text
┌─────────────────────────────────────────┐
│ <  オプションを比較                      │
├─────────────────────────────────────────┤
│ オプションA: 前払いなし                  │
│ ────────────────────────────────────────│
│ これまでに支払った総利息:                │
│   ¥5,200,000                            │
│ 残りの総利息: ¥5,200,000                 │
│ 残りの期間: 112期間                      │
│ 終了日: 2033/04/01                      │
│                                          │
│ オプションB: 前払い¥8,000,000            │
│ ────────────────────────────────────────│
│ 早期返済ペナルティ: ¥160,000             │
│ これまでに支払った総利息:                │
│   ¥5,360,000                            │
│ 残りの総利息: ¥2,200,000                 │
│ 残りの期間: 72期間                       │
│ 終了日: 2029/04/01                      │
│                                          │
│ 比較結果:                                │
│ • 利息の節約: ¥3,000,000                │
│ • 期間の短縮: 40期間（約3.5年）          │
│                                          │
│ [前払いを確認]                           │
└─────────────────────────────────────────┘
```

---

### LOAN-06: ローンを編集（基本情報を編集）

**目標**: 支払いを開始した後、ローンの基本情報（名前、銀行、メモ）を編集します。

**手順**:
1. ローン詳細に移動
2. **編集**をタップ（名前、メモ、銀行のみ編集可能）
3. 編集：
   - ローン名: 「住宅ローン - 都心のアパート - ユニットA1-1201」
   - （任意）銀行を変更: みずほ銀行
   - メモ: 「新しい銀行に移転」
4. 無効化されたフィールドを確認: ローン額、融資実行日、期間、金利
5. **保存**をタップ

**結果**: 基本情報が更新され、その他の情報は変更されません。

**注意**: ローンに支払いがまだ行われていない場合、すべての情報（額、期間、金利設定）を編集できます。

## 6. ロジックとルール

### 6.1 優遇/変動金利

- 優遇期間（低い金利）を持つことができます
- 優遇期間後、金利は期間ごとに変動します
- 各期間は**変動**（市場ベース）または**固定**にできます

### 6.2 延滞ペナルティ

- ペナルティは%/年で計算されます
- 各期間ごとに異なる設定が可能です
- ペナルティは支払いが遅れた場合にのみ適用されます

### 6.3 返済スケジュール

- アプリが以下に基づいて返済スケジュールを自動的に作成します：
  - ローン額
  - 金利
  - 期間
- 各返済期間には以下が含まれます: 元本 + 利息

### 6.4 早期返済

- 残額を計算（元本 + 利息 + ペナルティ（ある場合））
- 返済後、ローンは「完了」ステータスに変更されます

### 6.5 通知

- 返済期日になると、アプリがリマインド通知を送信します
- 各ローンの通知時間を設定できます（`notificationTime1`、`notificationTime2`、デフォルト10:00と19:00）

## 7. 重要な注意事項

- **複雑な金利**: このモジュールは期間ごとに変動する金利をサポートし、慎重な設定が必要です
- **返済スケジュールが存在する場合は削除できません**: 返済スケジュールが存在する場合、返済のみ可能で、削除はできません
- **早期返済**: 追加のペナルティ料金が必要な場合があります。銀行の方針によります
- **返済スケジュール**: 返済スケジュールは自動的に計算され、直接編集することはできません

