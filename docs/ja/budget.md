# 予算

## 1. 目的

**予算**モジュールは、月次支出を計画・追跡し、設定した予算を超えないようにします。このモジュールは以下に基づいて自動計算します：
- 定期収入
- 定期支出
- 実際の日々の支出

## 2. 使用するタイミング

以下の場合にこのモジュールを使用します：
- 月次支出を計画
- 予算を超えないように管理
- 貯蓄率を追跡
- カテゴリ別の支出分析を表示
- 月間の予算を比較

## 3. 関連画面

- 予算作成（初回または前月からコピー）
- 予算概要を表示
- 月別予算履歴
- 前月からのコピー提案

## 4. 主な使用方法

### 4.1 初回予算作成（ケースA）

1. **機能** → **予算**を選択
2. 予算が存在しない場合、アプリが自動的に**予算作成**画面を開きます
3. アプリが自動計算して表示：
   - **定期収入**: すべてのアクティブな定期収入の合計（読み取り専用、詳細内訳を表示）
   - **定期支出**: すべてのアクティブな定期支出の合計（読み取り専用、詳細内訳を表示）
   - **総予算（貯蓄前）**: 自動計算 = 定期収入 - 定期支出
4. **貯蓄率**を入力: 貯蓄率%（0-100%、必須）
5. **貯蓄額**と**支出予算**が自動計算されるのを確認
6. **予算を保存**をタップ

### 4.2 前月から予算をコピー（ケースC）

1. **機能** → **予算**を選択
2. 今月に予算がなく、前月に予算がある場合、アプリが**予算コピー提案**画面を表示
3. いずれかのオプションを選択：
   - **前月の予算全体をコピー**: アプリが自動的に貯蓄率をコピーし、現在のデータから定期収入/支出を再計算し、すぐに予算を作成
   - **コピーして調整**: アプリが前月から事前入力された貯蓄率で予算作成画面に移動、保存前に調整可能
   - **新しい予算を作成**: 最初から予算作成フローを実行（ケースA）
4. 「コピーして調整」を選択した場合、必要に応じて貯蓄率を調整
5. **予算を保存**をタップ

**注意**: コピー時、定期収入と定期支出は現在の定期データから再計算されます（前月からコピーされません）。貯蓄率のみがコピーされます。

### 4.3 予算概要を表示（ケースB）

1. **機能** → **予算**を選択
2. 今月に予算がある場合、アプリが**概要**画面を開きます
3. 情報を確認：
   - **支出予算**: 設定された支出制限
   - **使用済み**: 支出額（日々の支出と収入/支出の差異を含む）
   - **残り**: 予算の残額
   - **使用率**: 使用された予算の%（警告色付き）
   - **計画からの収入・支出の差異**: 元の計画からの差異
   - **カテゴリ別の日々の支出**: カテゴリ別の詳細な支出分析

### 4.4 今月の予算を編集

1. **予算概要**画面で、**「予算を編集」**ボタンをタップ
2. アプリが編集画面を表示：
   - **定期収入**と**定期支出**: 古い値を保持（読み取り専用）
   - **貯蓄率**: 現在の予算から事前入力（編集可能）
3. 必要に応じて貯蓄率を変更
4. 貯蓄額と支出予算が自動更新されるのを確認
5. **「予算を保存」**をタップ

**注意**: 編集時、定期収入と定期支出は再計算されません（古いスナップショットを保持）。貯蓄率と支出予算のみが更新されます。

### 4.5 予算履歴を表示

1. **機能** → **予算**を選択
2. メニューから**履歴**を選択
3. 過去の月の予算リストを表示
4. 月をタップして詳細を表示

### 4.6 カテゴリ別の支出詳細を表示

1. **予算概要**画面に移動
2. **カテゴリ別分析**セクションまでスクロール
3. カテゴリをタップ
4. そのカテゴリの支出リストを表示

## 5. 例とUI図解

### 5.1 BUDGET-01: 今月の初回予算作成

**目標**: 収入と定期支出に基づいて、アプリが自動的に月次支出を計算・追跡するように初回予算を作成します。

**手順**:
1. 機能画面に移動し、「予算管理」を選択
2. アプリが予算がないことを自動検出し、「予算作成」画面を表示
3. 自動計算された情報を確認: 定期収入、定期支出、総予算（貯蓄前）
4. 貯蓄率を入力: 20
5. 貯蓄額と支出予算が自動計算されるのを確認
6. 「予算を保存」ボタンをタップ

**結果**: 今月の予算が保存され、自動的に「予算概要」画面に移動します。

**UI図解**:

```text
[ カード: 2025年11月の予算作成 ]
+------------------------------------------------+
||                                                |
|| 定期収入                ¥120,000              |
||  • 私の給与（月次）      ¥120,000              |
||                                                |
|| 定期支出                ¥91,600               |
||  • 電気（月次）            ¥3,400            |
||  • 水道（月次）            ¥1,700            |
||  • BNの学費（月次）        ¥27,200           |
||  • 朝食とコーヒー（週次 x 4） ¥3,600        |
||  • 住宅ローン返済（月次）    ¥42,000         |
||                                                |
|| （このデータは自動的に取得されます）          |
+------------------------------------------------+

[ カード: 総予算（貯蓄前） ]
 ------------------------------------------------
||   ¥120,000 (定期収入)                        |
|| - ¥91,600 (定期支出)                          |
||-----------------------------------------------|
|| = ¥28,400 JPY                                 |
 ------------------------------------------------

[ カード: 貯蓄率 ]
 ------------------------------------------------
|| いくら貯めたいですか？                        |
||                                                |
|| 貯蓄率（%）                                    |
|| [  入力（必須）: 20  ]                         |
||                                                |
|| → 相当額: ¥5,700                               |
 ------------------------------------------------

[ カード: 支出予算 ]
 ------------------------------------------------
||    ¥28,400 (総予算（貯蓄前）)                |
|| -  ¥5,700 (貯蓄額)                            |
||-----------------------------------------------|
|| = ¥22,700 JPY                                 |
||                                                |
|| （食事、交通費、コーヒー、小さな買い物などが含まれます）
 ------------------------------------------------

[ ボタン ]
 -------------------------------
||      予算を保存              |
 -------------------------------
```

---

### 5.2 BUDGET-02: 今月の予算概要を表示

**目標**: 設定した予算と比較して支出状況を表示し、使用額、残額、カテゴリ別分析を含みます。

**手順**:
1. 機能画面に移動し、「予算管理」を選択
2. アプリが予算が存在することを自動検出し、「予算概要」画面を表示
3. カード1 - 月次予算を確認: 支出予算、使用済み、残り、使用率
4. カード2 - 計画からの収入・支出の差異を確認
5. カード3 - カテゴリ別の日々の支出を確認
6. （オプション）「支出予算 ›」をクリックして、予算計算を説明する詳細ダイアログを表示

**結果**: プログレスリング/バーと適切な色で、今月の予算情報を完全に表示します。

**UI図解**:

```text
[ カード1 – 2025年11月の予算 ]
┌──────────────────────────────────────────────┐
│ 2025年11月の予算                              │
│                                             │
│ 支出予算 ›      ¥22,700                     │
│ 使用済み        ¥3,500                      │
│  • 日々の支出              ¥4,800            │   
│  • 収入の差異      -¥16,000                │
│  • 支出の差異       +¥800                  │
│ 残り            ¥10,400                     │
│                                             │
│                    15.4%                    │
│   （今月の支出予算の15.4%を使用しました）
│   （今月の支出予算を使い切ろうとしています）
│                                             │
│                               [履歴を表示]│
└──────────────────────────────────────────────┘

[ カード2 – 計画からの収入・支出の差異 ]
┌──────────────────────────────────────────────┐
│ 計画からの収入・支出の差異                    │
│                                              │
│ 定期収入                                       │
│  • 私の給与                 +¥8,000          │
│    （¥48,000 > ¥40,000）                     │
│                                              │
│ 定期支出                                       │
│  • BNの学費              -¥400              │
│    （¥28,400 > ¥28,000）                     │
│                                              │
│ 総収入差異:        +¥24,000                  │
│ 総支出差異:        -¥800                    │
└──────────────────────────────────────────────┘

[ カード3 – カテゴリ別の日々の支出 ]
┌──────────────────────────────────────────────┐
│ カテゴリ別の日々の支出                        │
│ （食事、交通費、コーヒー、小さな買い物など）
│                                             │
│ 日々の支出合計: ¥4,800                       │
│                                             │
│ 食事              ¥2,400    50% [█████---------]│
│ 交通費             ¥1,200    25% [███-----------]│
│ コーヒー             ¥800     17% [██------------]│
│ 小さな買い物         ¥400     8%  [█-------------]│
└──────────────────────────────────────────────┘
```

---

### 5.3 BUDGET-03: 今月の予算を編集

**目標**: 貯蓄率を調整して、今月の支出予算を変更します。

**手順**:
1. 「予算概要」画面で、「予算を編集」ボタンをタップ
2. アプリが編集画面を表示（予算作成画面と類似）
3. 現在の情報を確認: 定期収入、定期支出（古い値を保持）
4. 貯蓄率を25に変更
5. 貯蓄額と支出予算が自動更新されるのを確認
6. 「予算を保存」ボタンをタップ

**結果**: 予算が更新され、新しい値で「予算概要」画面に戻ります。

**UI図解**: BUDGET-01（予算作成画面）と類似していますが、定期収入と定期支出の値は読み取り専用で、古い予算から保持されます。

---

### 5.4 BUDGET-04: 新しい月を開始する際に前月から予算をコピー

**目標**: 前月の予算を再利用して新しい予算作成の時間を節約し、必要に応じて調整するオプションを提供します。

**手順**:
1. 機能画面に移動し、「予算管理」を選択
2. アプリが今月に予算がなく、前月に予算があることを自動検出し、「予算コピー提案」画面を表示
3. 「コピーして調整」を選択
4. アプリが前月から事前入力された貯蓄率で予算作成画面に移動
5. （オプション）必要に応じて貯蓄率を調整
6. 「予算を保存」ボタンをタップ

**結果**: 今月の新しい予算が作成され、自動的に「予算概要」画面に移動します。

**UI図解**:

```text
[ 画面 ]  2025年12月の予算
┌──────────────────────────────────────────────┐
│ 2025年12月には予算がありません                │
│                                              │
│ 新しい月の予算をどのように作成しますか？      │
├──────────────────────────────────────────────┤
│                                              │
│ 📝 コピーして調整 ›                          │
│    ヒント: 2025年11月の予算をコピーして調整   │
│                                              │
├──────────────────────────────────────────────┤
│                                              │
│ ➕ 新しい予算を作成 ›                        │
│   ヒント: 予算作成フローを再度実行            │
│                                              │
└──────────────────────────────────────────────┘
```

「コピーして調整」を選択した後、予算作成画面はBUDGET-01と同様に表示されますが、貯蓄率は前月から事前入力されます。

## 6. ロジックとルール

### 6.1 ケース

- **ケースA**: 初回予算作成（どの月にも予算がない）
- **ケースB**: 今月に予算がある → 概要を表示
- **ケースC**: 今月にはないが、前月にはある → コピー提案

### 6.2 自動計算

- **定期収入**: すべてのアクティブな`recurring_income`の合計
- **定期支出**: すべてのアクティブな`recurring_expense`の合計
- **日々の支出**: 月の`daily_expense`の合計
- **総予算**: 定期収入 + 臨時収入
- **貯蓄**: 総予算 × 貯蓄率

### 6.3 他のモジュールとの統合

- 定期収入を確認すると → 予算を自動更新
- 定期支出を確認すると → 予算を自動更新
- 日々の支出は予算に自動計算されます

### 6.4 予算超過警告

- 支出が予算を超えると、アプリが警告を表示します
- ホーム画面と通知に警告が表示されます

### 6.5 スナップショット

- 予算を作成する際、アプリは収入/支出項目のスナップショットを作成して、その時点の状態を保存します
- スナップショットは比較と分析に使用されます

## 7. 重要な注意事項

- **月に1つの予算**: 各月の予算を作成する必要があります
- **予算の編集**: 貯蓄率を変更して今月の予算を編集できます。定期収入と定期支出は変更されません（スナップショット）で、正確性を確保します
- **自動更新**: 収入/支出を確認すると、予算が自動的に更新されます
- **前月からコピー**: コピー機能により、予算作成の時間を節約できます

