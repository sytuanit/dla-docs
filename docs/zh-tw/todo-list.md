# 待辦事項清單

## 1. 目的

**待辦事項清單**模組可協助您管理重複性任務並追蹤完成進度，包括：
- 基於時間的重複性任務（每日/每週/每月/每年）
- 基於指標的重複性任務（英里/小時/次數...）
- 到期時的提醒
- 完成歷史追蹤
- 支出記錄（如適用）

此模組可協助您永遠不會錯過重要任務，例如汽車保養、濾芯更換、定期檢查等。

## 2. 使用時機

當您有：
- 按計劃重複的任務（例如：每 3 個月更換水濾芯）時
- 基於指標重複的任務（例如：每 3,000 英里更換機油）時
- 需要到期時自動提醒時
- 想追蹤完成歷史時
- 需要記錄相關支出時

## 3. 相關畫面

- 待辦事項清單畫面
- 選擇任務類型（基於時間 / 基於指標）
- 新增待辦事項
- 編輯待辦事項
- 確認基於指標的任務
- 待辦事項歷史
- 到期任務清單（鈴鐺清單）

## 4. 主要使用方式

### 4.1 新增基於時間的待辦事項

1. 前往**功能** → 選擇**待辦事項清單**
2. 點擊右下角的 **+** (FAB) 按鈕
3. 選擇**基於時間的待辦事項**
4. 填寫資訊：
   - **任務名稱**：（必填，例如：「更換水濾芯」）
   - **重複週期**：輸入數字並選擇單位（日/週/月/年）
   - **下次到期日期**：選擇日期（僅允許選擇從明天開始）
   - **提醒時間**：選擇時間（必填，例如：08:00）
   - **此任務產生支出**：（選填）如果有支出，請勾選
     - 如果勾選：選擇**類別**（必填）
   - **備註**：其他資訊（選填）
5. 點擊**儲存**

### 4.2 新增基於指標的待辦事項

1. 前往**功能** → 選擇**待辦事項清單**
2. 點擊 **+** (FAB) 按鈕
3. 選擇**基於指標的待辦事項**
4. 填寫資訊：
   - **任務名稱**：（必填，例如：「更換機油」）
   - **週期**：輸入數字（例如：3,000）
   - **單位**：輸入單位（例如：「英里」）
   - **上次完成的指標值**：輸入目前值（例如：12,500）
   - **此任務產生支出**：（選填）如果有支出，請勾選
     - 如果勾選：選擇**類別**（必填）
   - **備註**：其他資訊（選填）
5. 點擊**儲存**

### 4.3 確認基於指標的任務

1. 前往待辦事項清單
2. 找到要確認的基於指標的任務（METRIC 類型）
3. 點擊卡片中的**確認**按鈕（僅在 `isActive = true` 時顯示）
4. 填寫資訊：
   - **目前指標值**：輸入目前值（必填，必須 ≥ 上次完成的指標值）
   - **備註**：（選填）
5. 查看自動計算的**增量**（目前值 - 上次完成值）
6. 點擊**已確認**
7. （如果任務有支出）選擇**新增支出**或**取消**

**注意**：基於時間的任務（CYCLE 類型）在卡片中沒有「確認」按鈕。確認僅在「到期任務」（鈴鐺清單）畫面中完成。

### 4.4 查看清單和詳細資訊

1. 前往**功能** → 選擇**待辦事項清單**
2. 使用**搜尋列**依任務名稱搜尋
3. 使用**篩選晶片**篩選：
   - **全部**：顯示所有任務
   - **基於時間**：僅顯示 CYCLE 類型任務
   - **基於指標**：僅顯示 METRIC 類型任務
4. 點擊任務卡片查看詳細資訊並編輯

### 4.5 編輯待辦事項

1. 前往待辦事項清單
2. 點擊任務卡片進行編輯
3. 更新資訊：
   - **備註**：如果有歷史記錄，**週期**（CYCLE）或**單位/週期**（METRIC）將被鎖定且無法編輯
4. 點擊**儲存**

### 4.6 查看歷史

1. 前往待辦事項清單
2. 點擊任務的**查看歷史 ›**連結查看
3. 使用**篩選晶片**依時間篩選：
   - **全部**：顯示所有歷史
   - **本月**：僅顯示本月的歷史
   - **上月**：僅顯示上月的歷史
   - **最近 3 個月**：僅顯示最近 3 個月的歷史

### 4.7 停用/啟用任務

1. 前往待辦事項清單
2. 找到要停用/啟用的任務
3. 切換卡片頁尾中的**啟用**開關
4. 已停用的任務將顯示**「已停用」**標籤（灰色）

### 4.8 刪除待辦事項

1. 前往待辦事項清單
2. 點擊卡片標題中的**刪除**圖示（🗑️）
3. 在對話框中確認刪除
4. 任務和所有相關歷史將被刪除

## 5. 範例與介面說明

### TODO-01：建立基於時間的待辦事項（更換水濾芯）

**目標**：建立基於時間的待辦事項，讓應用程式在到期時自動提醒您。

**主要步驟**：
1. 前往功能 → 待辦事項清單 → 點擊「+」(FAB) 按鈕
2. 選擇「基於時間的待辦事項」
3. 輸入任務名稱：「更換水濾芯」
4. 輸入週期：「3」個月
5. 選擇下次到期日期：03/01/2026
6. 選擇提醒時間：08:00
7. 勾選「此任務產生支出」，選擇類別「水電瓦斯費」
8. 輸入備註：「更換濾芯 #1 和 #2」
9. 點擊「儲存」

**線框圖 - 新增基於時間的待辦事項畫面**：

```text
┌──────────────────────────────────────────────┐
│ <  新增基於時間的待辦事項                    │
├──────────────────────────────────────────────┤

任務名稱
[ 更換水濾芯            ]

重複週期
每 [ 3 ] [ 月 ▼ ]
（單位：日 / 週 / 月 / 年）

下次到期日期
[ 03 / 01 / 2026    ▼ ]
提示： 
首次到期日期。
後續日期將根據您輸入的週期自動計算。

提醒時間
[ 08 : 00           ▼ ]

──────────────────────────────────────────────
[✓] 此任務產生支出

┌─────────────────────────────────────┐
│ 類別 *                               │
│ [水電瓦斯費 ▼] [+ 建立新類別]        │
└─────────────────────────────────────┘

──────────────────────────────────────────────
備註（選填）
[                                          ]
[                                          ]
[                                          ]

──────────────────────────────────────────────
[ 取消 ]                         [ 儲存 ]
└──────────────────────────────────────────────┘
```

---

### TODO-02：建立基於指標的待辦事項（更換機油）

**目標**：建立基於指標的待辦事項以追蹤基於里程的汽車保養。

**主要步驟**：
1. 前往功能 → 待辦事項清單 → 點擊「+」(FAB) 按鈕
2. 選擇「基於指標的待辦事項」
3. 輸入任務名稱：「更換機油」
4. 輸入週期：「3,000」，單位：「英里」
5. 輸入上次完成的指標值：「12,500」
6. 勾選「此任務產生支出」，選擇類別「汽車保養」
7. 輸入備註：「更換機油 + 機油濾芯」
8. 點擊「儲存」

**線框圖 - 新增基於指標的待辦事項畫面**：

```text
┌──────────────────────────────────────────────┐
│ <  新增基於指標的待辦事項                    │
├──────────────────────────────────────────────┤

任務名稱
[ 更換機油                        ]

週期
每 [ 3,000 ] 單位 [ 英里 ]
（單位：英里 / 小時 / 次數 / ...）

上次完成的指標值
[ 12,500 ]

──────────────────────────────────────────────
[✓] 此任務產生支出

┌─────────────────────────────────────┐
│ 類別 *                               │
│ [汽車保養 ▼] [+ 建立新類別]          │
└─────────────────────────────────────┘

──────────────────────────────────────────────
備註（選填）
[                                          ]
[                                          ]
[                                          ]

──────────────────────────────────────────────
[ 取消 ]                         [ 儲存 ]
└──────────────────────────────────────────────┘
```

---

### TODO-03：查看清單和詳細資訊

**目標**：查看待辦事項的概覽，依類型篩選，搜尋，並查看每個任務的詳細資訊。

**主要步驟**：
1. 前往功能 → 待辦事項清單
2. 查看帶有搜尋列和篩選晶片的清單
3. 使用篩選：「全部」、「基於時間」、「基於指標」
4. 使用搜尋列依任務名稱搜尋
5. 點擊任務卡片查看詳細資訊

**線框圖 - 待辦事項清單畫面**：

```text
┌─────────────────────────────────────────────────────────┐
│  [← 返回]  待辦事項清單                        [🔔]        │
└─────────────────────────────────────────────────────────┘
│  🔍 搜尋...                                             │
│                                                          │
│  [全部] [基於時間] [基於指標]                          │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 卡片：更換水濾芯                                  │    │
│  │ ┌─────────────────────────────────────────────┐ │    │
│  │ │ 更換水濾芯    [已完成] [🗑️]                 │ │    │
│  │ │                                              │ │    │
│  │ │ 📅 週期：每 3 個月                            │ │    │
│  │ │ ✅ 上次完成：12/01/2025                       │ │    │
│  │ │ 📅 下次到期日期：03/01/2026                  │ │    │
│  │ │ ⏳ 剩餘 76 天                                 │ │    │
│  │ │ ───────────────────────────────────────────── │ │    │
│  │ │ 查看歷史 ›                     [⚪ 啟用中]│ │    │
│  │ └─────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 卡片：更換機油                                    │    │
│  │ ┌─────────────────────────────────────────────┐ │    │
│  │ │ 更換機油                       [🗑️]         │ │    │
│  │ │                                              │ │    │
│  │ │ 📏 追蹤方式：英里                             │ │    │
│  │ │ ✅ 上次確認：12/02/2025                       │ │    │
│  │ │ 🔢 上次指標值：12,500 英里                   │ │    │
│  │ │ 🎯 下次到期：14,500 英里                      │ │    │
│  │ │ ⏳ ~300 英里剩餘                              │ │    │
│  │ │ ───────────────────────────────────────────── │ │    │
│  │ │ [✓ 確認]                                      │ │    │
│  │ │ ───────────────────────────────────────────── │ │    │
│  │ │ 查看歷史 ›                     [⚪ 啟用中]│ │    │
│  │ └─────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  [+ FAB]                                                 │
└─────────────────────────────────────────────────────────┘
```

---

### TODO-04：確認基於指標的任務（更換機油）

**目標**：透過輸入目前指標值確認基於指標的任務完成。

**主要步驟**：
1. 前往待辦事項清單
2. 找到「更換機油」任務（METRIC 類型）
3. 點擊「確認」按鈕
4. 輸入目前指標值：「14,520」
5. 查看自動計算的增量：「+2,020 英里」
6. 輸入備註：「更換機油 + 機油濾芯」
7. 點擊「已確認」

**線框圖 - 確認基於指標的任務對話框**：

```text
┌──────────────────────────────────────────────┐
│  確認基於指標的任務                           │
├──────────────────────────────────────────────┤

任務名稱：
更換機油   （唯讀）

追蹤方式：
英里   （唯讀）

上次完成的指標值：
12,500 英里   （唯讀）

──────────────────────────────────────────────
目前指標值
[ 14,520 ] 英里

增量：
+2,020 英里   （自動）

──────────────────────────────────────────────
備註
[                                          ]
[                                          ]
[                                          ]

──────────────────────────────────────────────
        [ 未確認 ]    [ 已確認 ]
└──────────────────────────────────────────────┘
```

---

### TODO-05：編輯待辦事項和查看歷史

**目標**：編輯待辦事項資訊並查看完成歷史。

**主要步驟**：
1. 前往待辦事項清單
2. 點擊「更換水濾芯」任務卡片
3. 查看警告：「⚠️ 週期已鎖定，因為有歷史記錄」（如果有歷史記錄）
4. 編輯下次到期日期、提醒時間、備註
5. 點擊「儲存」
6. 點擊「查看歷史 ›」查看帶有篩選的歷史

**線框圖 - 待辦事項歷史畫面**：

```text
┌─────────────────────────────────────────────────────────┐
│  [← 返回]  待辦事項歷史 - 更換水濾芯                      │
└─────────────────────────────────────────────────────────┘
│  [全部] [本月] [上月] [最近 3 個月]                      │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 更換水濾芯            [已完成]                   │    │
│  │                                                  │    │
│  │ 📅 週期：每 3 個月                                │    │
│  │ ✅ 完成於：12/01/2025 – 09:10                   │    │
│  │ 📝 備註：更換濾芯 #1 和 #2                       │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 更換水濾芯            [已完成]                   │    │
│  │                                                  │    │
│  │ 📅 週期：每 3 個月                                │    │
│  │ ✅ 完成於：09/01/2025 – 08:45                   │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

---

### TODO-06：停用和刪除待辦事項

**目標**：不再需要時停用或刪除待辦事項。

**主要步驟**：
1. 前往待辦事項清單
2. 找到要停用的任務
3. 點擊「啟用」開關關閉
4. 查看「已停用」標籤出現
5. 再次點擊開關重新啟用
6. 點擊刪除圖示（🗑️）刪除任務
7. 在對話框中確認刪除

---

### TODO-07：確認基於指標的任務並新增支出

**目標**：確認基於指標的任務並自動新增相關支出。

**主要步驟**：
1. 前往待辦事項清單
2. 找到「更換機油」任務（METRIC 類型，hasCost = true）
3. 點擊「確認」按鈕
4. 輸入目前指標值：「14,520」
5. 輸入備註：「更換機油 + 機油濾芯」
6. 點擊「已確認」
7. 查看「產生支出？」對話框自動開啟
8. 點擊「新增支出」
9. 查看「新增支出」畫面，備註和類別已預先填入
10. 輸入金額：1,500 TWD
11. 點擊「儲存」

**線框圖 - 產生支出對話框**：

```text
┌──────────────────────────────────────────────┐
│  產生支出？                                   │
├──────────────────────────────────────────────┤
您想為此完成新增支出嗎？

        [ 取消 ]         [ 新增支出 ]
└──────────────────────────────────────────────┘
```

## 6. 邏輯與規則

### 6.1 待辦事項類型

- **基於時間（CYCLE 類型）**：
  - 按計劃重複（日/週/月/年）
  - 到期時有提醒通知
  - 確認僅在「到期任務」（鈴鐺清單）畫面中完成
  - 卡片中沒有「確認」按鈕

- **基於指標（METRIC 類型）**：
  - 基於指標里程碑重複（英里/小時/次數/其他）
  - 無通知（MVP1）
  - 卡片中有「確認」按鈕（僅在 `isActive = true` 時顯示）
  - 透過輸入目前指標值確認

### 6.2 待辦事項狀態

- **PENDING**：即將到來（尚未到期）
  - 不顯示標籤：`nextDueDate - today > 7 天`
  - 顯示「即將到來」標籤（黃色）：`0 < nextDueDate - today ≤ 7 天`
- **OVERDUE**：逾期（紅色）- `nextDueDate < today` 且未確認
- **NOT_COMPLETED**：未完成（橙色）- 到期但未確認
- **COMPLETED**：已完成（綠色）- 已確認
- **CANCELLED**：已取消（灰色）- 此發生事件已取消
- **INACTIVE**：已停用（灰色）- `isActive = false`

### 6.3 鎖定週期/單位

- 如果有歷史記錄（歷史記錄）：
  - **CYCLE 類型**：週期已鎖定，無法編輯
  - **METRIC 類型**：單位和週期已鎖定，無法編輯
- 顯示警告：「⚠️ 週期已鎖定，因為有歷史記錄」或「⚠️ 單位已鎖定，因為有歷史記錄」

### 6.4 確認基於指標的任務

- **驗證**：
  - 目前指標值必須 ≥ 上次完成的指標值
  - 如果無效：顯示錯誤「目前指標值必須 ≥ 上次完成的指標值」
- **自動更新**：
  - `lastMetricValue` = 目前值
  - `nextMetricValue` = 目前值 + 週期
  - `lastCompletedDate` = 今天
- **支出**：
  - 如果 `hasCost = true`：成功確認後顯示「產生支出？」對話框
  - 導航到「新增支出」畫面，帶有 `initialNote`、`initialCategoryId`、`todoHistoryId`

### 6.5 通知

- **CYCLE 類型**： 
  - 建立/編輯任務時排程通知
  - 停用或刪除任務時取消通知
  - 重新啟用時重新排程通知（如果 `nextDueDate >= today`）
- **METRIC 類型**：無通知（MVP1）

### 6.6 計算下次到期日期

- **CYCLE 類型**： 
  - 確認後根據週期自動計算下次到期日期
  - 範例：週期 3 個月，到期日期 03/01/2026 → 確認後，下次到期日期 = 06/01/2026
- **METRIC 類型**： 
  - 下次到期 = 目前值 + 週期
  - 範例：目前值 14,520 英里，週期 3,000 英里 → 下次到期 = 17,520 英里

## 7. 重要注意事項

1. **確認按鈕**：
   - **基於時間的任務（CYCLE）**：卡片中沒有「確認」按鈕。確認僅在「到期任務」（鈴鐺清單）畫面中完成。
   - **基於指標的任務（METRIC）**：卡片中有「確認」按鈕（僅在 `isActive = true` 時顯示）。

2. **鈴鐺圖示**：標題中的鈴鐺圖示導航到「到期任務」（鈴鐺清單）畫面，使用者可以在其中確認到期任務（僅限 CYCLE 類型）。

3. **鎖定週期/單位**：如果有歷史記錄，週期（CYCLE）或單位/週期（METRIC）將被鎖定且無法編輯，以確保資料一致性。

4. **指標驗證**：確認基於指標的任務時，目前指標值必須 ≥ 上次完成的指標值。如果不是，應用程式將顯示錯誤並阻止確認。

5. **產生支出**：如果任務有支出（`hasCost = true`），成功確認後，應用程式將詢問您是否要新增支出。如果您選擇「新增支出」，應用程式將自動預先填入備註和類別。

6. **刪除任務**：刪除任務時，所有相關歷史也將被刪除（級聯刪除）。通知也將被取消。

7. **停用**：停用 CYCLE 類型任務時，通知將被取消。重新啟用時，通知將重新排程（如果 `nextDueDate >= today`）。

8. **高級存取**：此模組需要高級存取。如果您沒有高級版，應用程式將顯示要求升級的對話框。

