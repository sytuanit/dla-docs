# 报告

## 1. 目的

**报告**模块提供详细的财务报告，帮助您：
- 查看当月的财务概览
- 分析收入和支出
- 追踪储蓄进度
- 预测月末支出
- 按类型查看报告（收入、支出、储蓄、贷款）

## 2. 使用时机

当您想：
- 查看财务概览时
- 分析支出趋势时
- 检查储蓄目标进度时
- 预测预算超支风险时
- 按类型查看详细报告时

## 3. 相关画面

- 概览报告
- 收入报告
- 支出报告
- 储蓄报告
- 贷款报告

## 4. 主要使用方式

### 4.1 查看概览报告

1. 前往底部导航中的**报告**标签
2. 查看**财务健康**部分：
   - 储蓄目标和实际储蓄（带进度条和达成水平）
   - 净现金流（带详细公式）
   - 预算剩余（如果已创建预算）
   - 与上月相比的支出速度（如果有数据）
   - 本月贷款义务（如有）
   - 前 5 大支出类别（按百分比）
3. 查看**未来趋势预测**部分（如果预算 > 0）：
   - 月末预期剩余（带详细公式）
   - 储蓄目标达成概率
   - 即将到来的贷款付款（如有）
4. 点击卡片滚动到相应的详细报告

### 4.2 查看收入报告

1. 从报告画面，点击"详细报告"部分中的菜单项 **💵 收入**
2. 查看本月总实际收入
3. 查看**定期收入**部分：总计、已收到、尚未收到、每个项目的详细信息
4. 查看**额外收入**部分（如有）：总计、每个项目的详细信息、增减百分比
5. 查看**3 个月收入趋势**（如果有足够数据）
6. 查看**每月收入历史**
7. 查看**收入分析（洞察）**：百分比、稳定性水平、趋势

### 4.3 查看支出报告

1. 从报告画面，点击"详细报告"部分中的菜单项 **🔥 支出**
2. 查看本月总实际支出，以及与上月相比的增减百分比
3. 查看**定期支出**部分：总计、已付、尚未支付、每个项目的详细信息
4. 查看**按类别的日常支出**部分：前几大类别（带金额和百分比）
5. 查看**支出激增**部分（如果有上月数据）
6. 查看**3 个月支出趋势**（如果有足够数据）
7. 查看**每月支出历史**

### 4.4 查看预算报告

1. 从报告画面，点击"详细报告"部分中的菜单项 **📉 预算**（仅在已创建预算时显示）
2. 查看**本月预算概览**：每月预算、已支出（带明细）、剩余、进度条
3. 点击"每月预算"查看**预算详细信息对话框**（带计算方法）
4. 查看**与计划的差异**部分：收入和支出项目（带差异）、总差异
5. 查看**按类别的支出**部分：总计、每个类别（带金额、百分比、进度条）
6. 点击类别查看该类别中的支出清单

### 4.5 查看储蓄报告

1. 从报告画面，点击"详细报告"部分中的菜单项 **💾 储蓄**（仅在存在储蓄账户时显示）
2. 查看**本月实际储蓄**（带净现金流公式）
3. 查看**储蓄分析**部分：收入百分比、与上月比较、月末预测
4. 查看**储蓄账户清单**部分：所有启用中账户，按最近到期日排序
5. 查看**6 个月储蓄增长图表**（如果有超过 1 个月的数据）

### 4.6 查看贷款报告

1. 从报告画面，点击"详细报告"部分中的菜单项 **💸 贷款**（仅在存在贷款时显示）
2. 查看**贷款概览**：当前债务余额、本月贷款成本（带本金 + 利息明细）
3. 查看**最近付款**部分：到期日期、状态、距离下次付款的天数
4. 查看**每月付款时间表**部分：最近 3 个月（带金额和状态）
5. 查看**贷款分析（洞察）**部分：总付款、债务余额趋势、利率、逾期付款风险
6. 查看**6 个月债务减少图表**（如果有超过 1 个月的数据）

## 5. 示例与用户界面图示

### 5.1 REPORT-01：查看财务健康概览和趋势预测

**目标**：查看当月的财务概览，包括储蓄进度、净现金流、预算剩余和月末预测。

**步骤**：
1. 前往底部导航中的**报告**标签
2. 查看**财务健康**部分：
   - 储蓄目标：4,200 CNY（收入的 20%）
   - 实际储蓄：2,940 CNY
   - 进度条：70% - 达成水平：中等
   - 净现金流：+1,960 CNY [正数]（带详细公式）
   - 预算剩余：4,340 CNY [稳定]（62% 预算 ≈ 60% 时间）
   - 支出速度：比上月高 12%
   - 贷款义务：2,940 CNY [已付]
   - 前 5 大类别：饮食（32%）、购物（25%）、娱乐（18%）、交通（15%）、其他（10%）
3. 查看**未来趋势预测**部分：
   - 月末预期剩余：+1,610 CNY [盈余]（带详细公式）
   - 目标达成概率：82% [接近达成]
   - 即将到来的贷款付款：第 25 天：2,940 CNY [资金充足]

**线框图**：
```text
┌──────────────────────┐  ┌──────────────────────┐
│ 🎯 储蓄目标           │  │ 💾 实际储蓄          │
│ 4,200 CNY            │  │ 2,940 CNY            │
│ 收入的 20%           │  │                      │
└──────────────────────┘  └──────────────────────┘

[██████████████----------------------] 70%
达成水平：中等

┌────────────────────────────────────────────────────────────┐
│ 净现金流 = 实际储蓄                                        │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ +1,960 CNY                      [正数]                  │ │
│ └────────────────────────────────────────────────────────┘ │
│ 净现金流 = 收入（定期 + 额外）                              │
│                – 支出（定期 + 日常 + 贷款）                │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│ 📉 预算剩余                                                │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 4,340 CNY                      [稳定]                  │ │
│ └────────────────────────────────────────────────────────┘ │
│ • 62% 预算 ≈ 60% 时间 → 支出速度适当                       │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│ 💹 月末预期剩余                                            │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 预期：+1,610 CNY             [盈余]                     │ │
│ └────────────────────────────────────────────────────────┘ │
│ • 预期支出 = (平均每日支出 × 剩余天数)                      │
│                + (待处理的固定支出)                         │
└────────────────────────────────────────────────────────────┘
```

### 5.2 REPORT-02：查看收入报告

**目标**：查看本月收入的详细分析，包括定期收入、额外收入、趋势和洞察。

**步骤**：
1. 从报告画面，点击"详细报告"部分中的菜单项 **💵 收入**
2. 查看**本月总实际收入**：14,700 CNY
3. 查看**定期收入**部分：总计 10,500 CNY（已收到：9,100 CNY，尚未收到：1,400 CNY），每个项目的详细信息
4. 查看**额外收入**部分：总计 4,200 CNY（自由工作：2,100 CNY，出售物品：700 CNY，小额奖金：1,400 CNY），比上月增加 5%
5. 查看**3 个月收入趋势**（迷你图表）
6. 查看**每月收入历史**：本月、上月、2 个月前
7. 查看**收入分析（洞察）**：定期收入百分比、稳定性评估、增减百分比

**线框图**：参考 `wf-bao-cao-thu-nhap.md`

### 5.3 REPORT-03：查看支出报告

**目标**：查看本月支出的详细分析，包括定期支出、按类别的日常支出、趋势和支出激增类别。

**步骤**：
1. 从报告画面，点击"详细报告"部分中的菜单项 **🔥 支出**
2. 查看**本月总实际支出**：12,740 CNY（比上月增加 12%）
3. 查看**定期支出**部分：总计 5,950 CNY（已付：5,250 CNY，尚未支付：700 CNY），每个项目的详细信息
4. 查看**按类别的日常支出**部分：饮食 4,550 CNY（36%）、购物 2,100 CNY（16%）、交通 1,470 CNY（12%）、娱乐 980 CNY（8%）、其他 700 CNY（5%）
5. 查看**支出激增**部分：饮食（+840 CNY，+22%）、购物（+560 CNY，+35%）
6. 查看**3 个月支出趋势**（迷你图表）
7. 查看**每月支出历史**：本月、上月、2 个月前

**线框图**：参考 `wf-bao-cao-chi-tieu.md`

### 5.4 REPORT-04：查看预算报告

**目标**：查看本月预算概览，包括预算已支出、剩余、与计划的差异和按类别的支出。

**步骤**：
1. 从报告画面，点击"详细报告"部分中的菜单项 **📉 预算**
2. 查看**本月预算概览**：
   - 每月预算：7,000 CNY（点击查看计算详细信息）
   - 已支出：2,660 CNY（日常支出：1,750 CNY，支出差异：+350 CNY，收入差异：-140 CNY）
   - 剩余：4,340 CNY
   - 进度条：38.0%（带动态提示文本）
3. 点击"每月预算"查看**预算详细信息对话框**（带公式：预算 = 收入 - 支出）
4. 查看**与计划的差异**部分：每个收入/支出项目（带差异）、总差异
5. 查看**按类别的支出**部分：总计、每个类别（带金额、百分比、进度条）
6. 点击类别查看该类别中的支出清单

**线框图**：参考 `wf-bao-cao-ngan-sach.md`

### 5.5 REPORT-05：查看储蓄报告

**目标**：查看本月储蓄的详细分析，包括实际储蓄、储蓄分析、储蓄账户清单和趋势。

**步骤**：
1. 从报告画面，点击"详细报告"部分中的菜单项 **💾 储蓄**
2. 查看**本月实际储蓄**：2,940 CNY（带详细净现金流公式）
3. 查看**储蓄分析**部分：储蓄占收入的 20%，比上月增加 12%，月末预测：3,570 CNY（≈85% 的目标）
4. 查看**储蓄账户清单**部分：3 个账户（28,000 CNY、3,500 CNY、14,000 CNY），按最近到期日排序
5. 查看**6 个月储蓄增长图表**（折线图）

**线框图**：参考 `wf-bao-cao-tiet-kiem.md`

### 5.6 REPORT-06：查看贷款报告

**目标**：查看贷款的详细分析，包括当前债务余额、本月贷款成本、付款时间表、洞察和趋势。

**步骤**：
1. 从报告画面，点击"详细报告"部分中的菜单项 **💸 贷款**
2. 查看**贷款概览**：当前债务余额 455,000 CNY，本月贷款成本 2,940 CNY（本金：2,450 CNY + 利息：490 CNY）
3. 查看**最近付款**部分：第 25 天 → 已付，下次付款在 14 天后
4. 查看**每月付款时间表**部分：最近 3 个月（带金额和状态）
5. 查看**贷款分析（洞察）**部分：最近 3 个月付款：8,820 CNY，债务余额趋势稳步下降，利息占付款的 17%，逾期付款风险：低
6. 查看**6 个月债务减少图表**（折线图）

**线框图**：参考 `wf-bao-cao-khoan-vay.md`

### 5.7 REPORT-07：从概览报告分析按类别的支出

**目标**：从概览报告，点击"按类别的支出"部分以查看详细支出报告和更深入的分析。

**步骤**：
1. 从报告概览画面，滚动到**按类别的支出**部分
2. 查看前 5 大类别（按百分比）
3. 点击"按类别的支出"卡片（带右箭头图标）
4. 应用程序自动滚动到同一画面中的**支出报告**部分
5. 查看完整详细信息：总支出、定期支出、按类别的日常支出（超过前 5 大）、支出激增、趋势和历史

**线框图**：参考 `wf-bao-cao.md` - "按类别的支出"部分

### 5.8 REPORT-08：数据不足时查看报告（第一个月）

**目标**：新应用程序用户在第一个月查看报告，此时数据不足，无法进行比较和趋势分析。

**步骤**：
1. 前往**报告**标签
2. 查看**财务健康**部分：
   - 储蓄目标和实际储蓄（如果存在预算）
   - 净现金流（带公式）
   - 预算剩余（如果存在）
   - **不**显示："支出速度"（无上月数据）
3. 查看**未来趋势预测**部分（如果预算 > 0）
4. 点击**收入报告**：本月总收入、定期和额外收入，**不**显示"3 个月趋势"，历史中**仅**显示"本月"
5. 点击**支出报告**：本月总支出、定期和日常支出，**不**显示"支出激增"、"3 个月趋势"，历史中**仅**显示"本月"

**线框图**：参考 `wf-bao-cao.md` - 带条件显示的卡片

## 6. 逻辑与规则

### 6.1 净现金流计算

**公式**：
```
净现金流_月 = 
  (当月实际收到的定期收入 + 当月额外收入)
  - (当月实际支付的定期支出 + 当月日常支出 + 当月实际贷款付款)
```

**详细信息**：
- **收入**：SUM(recurring_income_occurrence.amount_snapshot) WHERE status = 'COMPLETED' AND due_date in month + SUM(extra_income.amount) WHERE occurred_at in month
- **支出**：SUM(recurring_expense_occurrence.amount_snapshot) WHERE status = 'COMPLETED' AND due_date in month + SUM(daily_expense.amount) WHERE occurred_at in month + SUM(bank_debt_payment.total_amount) WHERE due_date in month AND status != 'CANCELLED'
- **实际储蓄**：max(NetCashflow_month, 0) - 如果净现金流为正：储蓄 = 净现金流，如果净现金流为负：储蓄 = 0（超支）

### 6.2 储蓄目标达成水平

**公式**：
```
比率 = Saving_month / budget.savings_amount
进度% = round(比率 × 100)
```

**阈值**：
- **良好**：进度% ≥ 90
- **中等**：70 ≤ 进度% < 90
- **差**：进度% < 70

### 6.3 预算剩余

**公式**：
- % 预算剩余 = (预算剩余 / 总预算) × 100
- % 时间剩余 = (剩余天数 / 月总天数) × 100

**结论**：
- 如果 % 预算 ≈ % 时间：支出速度**合理**
- 如果 % 预算 < % 时间：支出**快于**速度
- 如果 % 预算 > % 时间：支出**慢于**速度

**注意**：此卡片仅在已为本月创建预算时显示。

### 6.4 月末预测

**预期支出**：
```
预期支出 = 
  (平均每日支出 × 月剩余天数)
  + 剩余月份待处理的定期支出总额
  + 当月待处理的银行贷款付款总额
```

**详细信息**：
- 平均每日支出 = (从月初到今天的总 daily_expense.amount) / 月已过天数
- 待处理的定期支出总额 = SUM(recurring_expense_occurrence.amount_snapshot) WHERE status = 'PENDING' AND due_date between 明天 and 月末
- 待处理的银行贷款付款总额 = SUM(bank_debt_payment.total_amount) WHERE due_date between 明天 and 月末 AND status = 'PENDING'

**月末预期剩余**：
```
月末预期剩余 = NetCashflow_month - 预期支出
```

**储蓄目标达成概率**：
```
比率 = 月末预期剩余 / budget.savings_amount
进度% = round(比率 × 100)
```

**标签**：
- ≥ 90% → **将达成**
- 70–89% → **接近达成**
- < 70% → **难以达成**

**注意**：预测仅在预算 > 0 时显示。

### 6.5 实际数据与计划

- **所有报告数据使用实际数据**：
  - 收入：已完成的发生事件 + extra_income
  - 支出：已完成的发生事件 + daily_expense
  - 贷款付款：due_date 在当月的 bank_debt_payment（无论是否已付）
- **不使用计划数据**（尚未到期的待处理发生事件）

## 7. 重要注意事项

- **仅当月数据**：报告仅显示当月数据
- **显示条件**：
  - "预算剩余"卡片仅在已为本月创建预算时显示
  - "支出速度"卡片仅在有上月数据可供比较时显示
  - "贷款义务"卡片仅在存在贷款时显示
  - "预算"菜单项仅在已创建预算时显示
  - "储蓄"菜单项仅在存在储蓄账户时显示
  - "贷款"菜单项仅在存在贷款时显示
  - "未来趋势预测"部分仅在预算 > 0 时显示
- **预测仅供参考**：基于当前趋势和待处理项目
- **第一个月**：由于缺乏比较数据，某些卡片/部分不显示（例如："支出速度"、"3 个月趋势"、"支出激增"）
- **卡片可点击**：点击卡片会滚动到同一画面中相应的详细报告

