# レポート

## 1. 目的

**レポート**モジュールは、詳細な財務レポートを提供し、以下を支援します：
- 今月の財務概要を表示
- 収入と支出を分析
- 貯蓄の進捗を追跡
- 月末の支出を予測
- タイプ別のレポートを表示（収入、支出、貯蓄、ローン）

## 2. 使用するタイミング

以下の場合にこのモジュールを使用します：
- 財務概要を表示
- 支出傾向を分析
- 貯蓄目標の進捗を確認
- 予算超過リスクを予測
- タイプ別の詳細レポートを表示

## 3. 関連画面

- 概要レポート
- 収入レポート
- 支出レポート
- 貯蓄レポート
- ローンレポート

## 4. 主な使用方法

### 4.1 概要レポートを表示

1. 下部ナビゲーションの**レポート**タブに移動
2. **財務の健全性**セクションを確認：
   - 貯蓄目標と実際の貯蓄（プログレスバーと達成レベル付き）
   - 詳細な式を含む正味キャッシュフロー
   - 予算の残り（予算が作成されている場合）
   - 前月と比較した支出ペース（データが利用可能な場合）
   - 今月のローン義務（ある場合）
   - パーセンテージ別の上位5つの支出カテゴリ
3. **将来の傾向予測**セクションを確認（予算 > 0の場合）：
   - 詳細な式を含む月末の予想残額
   - 貯蓄目標達成確率
   - 今後のローン返済（ある場合）
4. カードをタップして、対応する詳細レポートにスクロール

### 4.2 収入レポートを表示

1. レポート画面から、「詳細レポート」セクションのメニュー項目**💵 収入**をタップ
2. 今月の実際の収入合計を確認
3. **定期収入**セクションを確認: 合計、受領済み、まだ受領していない、各項目の詳細
4. **臨時収入**セクションを確認（ある場合）: 合計、各項目の詳細、増減率
5. **3ヶ月の収入傾向**を確認（十分なデータが利用可能な場合）
6. **月次収入履歴**を確認
7. **収入分析（インサイト）**を確認: パーセンテージ、安定性レベル、傾向

### 4.3 支出レポートを表示

1. レポート画面から、「詳細レポート」セクションのメニュー項目**🔥 支出**をタップ
2. 今月の実際の支出合計を確認（前月と比較した増減率付き）
3. **定期支出**セクションを確認: 合計、支払済み、まだ支払っていない、各項目の詳細
4. **カテゴリ別の日々の支出**セクションを確認: 金額とパーセンテージを含む上位カテゴリ
5. **支出急増**セクションを確認（前月のデータが利用可能な場合）
6. **3ヶ月の支出傾向**を確認（十分なデータが利用可能な場合）
7. **月次支出履歴**を確認

### 4.4 予算レポートを表示

1. レポート画面から、「詳細レポート」セクションのメニュー項目**📉 予算**をタップ（予算が作成されている場合のみ表示）
2. **今月の予算概要**を確認: 月次予算、支出（内訳付き）、残り、プログレスバー
3. 「月次予算」をタップして、計算方法を含む**予算詳細ダイアログ**を表示
4. **計画からの差異**セクションを確認: 差異を含む収入と支出項目、総差異
5. **カテゴリ別の支出**セクションを確認: 合計、金額、パーセンテージ、プログレスバーを含む各カテゴリ
6. カテゴリをタップして、そのカテゴリの支出リストを表示

### 4.5 貯蓄レポートを表示

1. レポート画面から、「詳細レポート」セクションのメニュー項目**💾 貯蓄**をタップ（貯蓄口座が存在する場合のみ表示）
2. 正味キャッシュフロー式を含む**今月の実際の貯蓄**を確認
3. **貯蓄分析**セクションを確認: 収入に対する%、前月との比較、月末予測
4. **貯蓄口座リスト**セクションを確認: すべてのアクティブな口座、最も近い満期日でソート
5. **6ヶ月の貯蓄成長チャート**を確認（1ヶ月以上のデータが利用可能な場合）

### 4.6 ローンレポートを表示

1. レポート画面から、「詳細レポート」セクションのメニュー項目**💸 ローン**をタップ（ローンが存在する場合のみ表示）
2. **ローン概要**を確認: 現在の債務残高、今月のローンコスト（元本 + 利息の内訳付き）
3. **最も近い返済**セクションを確認: 期日、ステータス、次の返済までの日数
4. **月次返済スケジュール**セクションを確認: 金額とステータスを含む過去3ヶ月
5. **ローン分析（インサイト）**セクションを確認: 過去3ヶ月の支払い、債務残高の傾向、金利、延滞リスク
6. **6ヶ月の債務削減チャート**を確認（1ヶ月以上のデータが利用可能な場合）

## 5. 例とUI図解

### 5.1 REPORT-01: 財務の健全性概要と傾向予測を表示

**目標**: 貯蓄の進捗、正味キャッシュフロー、予算の残り、月末予測を含む今月の財務概要を表示します。

**手順**:
1. 下部ナビゲーションの**レポート**タブに移動
2. **財務の健全性**セクションを確認：
   - 貯蓄目標: ¥60,000（収入の20%）
   - 実際の貯蓄: ¥42,000
   - プログレスバー: 70% - 達成レベル: 中
   - 正味キャッシュフロー: +¥28,000 [プラス] 詳細な式付き
   - 予算の残り: ¥62,000 [安定]（予算の62% ≈ 時間の60%）
   - 支出ペース: 前月より12%高い
   - ローン義務: ¥42,000 [支払済み]
   - 上位5カテゴリ: 食事（32%）、買い物（25%）、娯楽（18%）、交通費（15%）、その他（10%）
3. **将来の傾向予測**セクションを確認：
   - 月末の予想残額: +¥23,000 [余剰] 詳細な式付き
   - 目標達成確率: 82% [ほぼ達成]
   - 今後のローン返済: 25日: ¥42,000 [十分な資金]

**ワイヤーフレーム**:
```text
┌──────────────────────┐  ┌──────────────────────┐
│ 🎯 貯蓄目標          │  │ 💾 実際の貯蓄        │
│ ¥60,000              │  │ ¥42,000              │
│ 収入の20%            │  │                      │
└──────────────────────┘  └──────────────────────┘

[██████████████----------------------] 70%
達成レベル: 中

┌────────────────────────────────────────────────────────────┐
│ 正味キャッシュフロー = 実際の貯蓄                          │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ +¥28,000                      [プラス]                  │ │
│ └────────────────────────────────────────────────────────┘ │
│ 正味キャッシュフロー = 収入（定期 + 臨時）                  │
│                – 支出（定期 + 日々 + ローン）               │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│ 📉 予算の残り                                             │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ ¥62,000                      [安定]                    │ │
│ └────────────────────────────────────────────────────────┘ │
│ • 予算の62% ≈ 時間の60% → 適切なペースで支出              │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│ 💹 月末の予想残額                                         │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 予想: +¥23,000             [余剰]                     │ │
│ └────────────────────────────────────────────────────────┘ │
│ • 予想支出 = （平均日次支出 × 残り日数）                   │
│                + （保留中の固定支出）                      │
└────────────────────────────────────────────────────────────┘
```

### 5.2 REPORT-02: 収入レポートを表示

**目標**: 定期収入、臨時収入、傾向、インサイトを含む今月の収入の詳細分析を表示します。

**手順**:
1. レポート画面から、「詳細レポート」セクションのメニュー項目**💵 収入**をタップ
2. **今月の実際の収入合計**を確認: ¥210,000
3. **定期収入**セクションを確認: 合計¥150,000（受領済み: ¥130,000、まだ受領していない: ¥20,000）、各項目の詳細
4. **臨時収入**セクションを確認: 合計¥60,000（フリーランス: ¥30,000、アイテム販売: ¥10,000、小さなボーナス: ¥20,000）、前月から5%増加
5. **3ヶ月の収入傾向**を確認（スパークラインチャート）
6. **月次収入履歴**を確認: 今月、前月、2ヶ月前
7. **収入分析（インサイト）**を確認: 定期収入のパーセンテージ、安定性評価、増減率

**ワイヤーフレーム**: `wf-bao-cao-thu-nhap.md`を参照

### 5.3 REPORT-03: 支出レポートを表示

**目標**: 定期支出、カテゴリ別の日々の支出、傾向、支出急増カテゴリを含む今月の支出の詳細分析を表示します。

**手順**:
1. レポート画面から、「詳細レポート」セクションのメニュー項目**🔥 支出**をタップ
2. **今月の実際の支出合計**を確認: ¥182,000（前月から12%増加）
3. **定期支出**セクションを確認: 合計¥85,000（支払済み: ¥75,000、まだ支払っていない: ¥10,000）、各項目の詳細
4. **カテゴリ別の日々の支出**セクションを確認: 食事¥65,000（36%）、買い物¥30,000（16%）、交通費¥21,000（12%）、娯楽¥14,000（8%）、その他¥10,000（5%）
5. **支出急増**セクションを確認: 食事（+¥12,000、+22%）、買い物（+¥8,000、+35%）
6. **3ヶ月の支出傾向**を確認（スパークラインチャート）
7. **月次支出履歴**を確認: 今月、前月、2ヶ月前

**ワイヤーフレーム**: `wf-bao-cao-chi-tieu.md`を参照

### 5.4 REPORT-04: 予算レポートを表示

**目標**: 予算の支出、残り、計画からの差異、カテゴリ別の支出を含む今月の予算概要を表示します。

**手順**:
1. レポート画面から、「詳細レポート」セクションのメニュー項目**📉 予算**をタップ
2. **今月の予算概要**を確認：
   - 月次予算: ¥100,000（タップして計算詳細を表示）
   - 支出: ¥38,000（日々の支出: ¥25,000、支出差異: +¥5,000、収入差異: -¥2,000）
   - 残り: ¥62,000
   - プログレスバー: 38.0% 動的ヒントテキスト付き
3. 「月次予算」をタップして、式を含む**予算詳細ダイアログ**を表示: 予算 = 収入 - 支出
4. **計画からの差異**セクションを確認: 差異を含む各収入/支出項目、総差異
5. **カテゴリ別の支出**セクションを確認: 合計、金額、パーセンテージ、プログレスバーを含む各カテゴリ
6. カテゴリをタップして、そのカテゴリの支出リストを表示

**ワイヤーフレーム**: `wf-bao-cao-ngan-sach.md`を参照

### 5.5 REPORT-05: 貯蓄レポートを表示

**目標**: 実際の貯蓄、貯蓄分析、貯蓄口座リスト、傾向を含む今月の貯蓄の詳細分析を表示します。

**手順**:
1. レポート画面から、「詳細レポート」セクションのメニュー項目**💾 貯蓄**をタップ
2. 詳細な正味キャッシュフロー式を含む**今月の実際の貯蓄**を確認: ¥42,000
3. **貯蓄分析**セクションを確認: 収入の20%を貯蓄口座に、前月から12%増加、月末予測: ¥51,000（目標の約85%）
4. **貯蓄口座リスト**セクションを確認: 3つの口座（¥400,000、¥50,000、¥200,000）、最も近い満期日でソート
5. **6ヶ月の貯蓄成長チャート**を確認（折れ線グラフ）

**ワイヤーフレーム**: `wf-bao-cao-tiet-kiem.md`を参照

### 5.6 REPORT-06: ローンレポートを表示

**目標**: 現在の債務残高、今月のローンコスト、返済スケジュール、インサイト、傾向を含むローンの詳細分析を表示します。

**手順**:
1. レポート画面から、「詳細レポート」セクションのメニュー項目**💸 ローン**をタップ
2. **ローン概要**を確認: 現在の債務残高¥6,500,000、今月のローンコスト¥42,000（元本: ¥35,000 + 利息: ¥7,000）
3. **最も近い返済**セクションを確認: 25日 → 支払済み、次の返済まで14日
4. **月次返済スケジュール**セクションを確認: 金額とステータスを含む過去3ヶ月
5. **ローン分析（インサイト）**セクションを確認: 過去3ヶ月の支払い: ¥126,000、債務残高の傾向は着実に減少、利息は支払いの17%を占める、延滞リスク: 低
6. **6ヶ月の債務削減チャート**を確認（折れ線グラフ）

**ワイヤーフレーム**: `wf-bao-cao-khoan-vay.md`を参照

### 5.7 REPORT-07: 概要レポートからカテゴリ別の支出を分析

**目標**: 概要レポートから「カテゴリ別の支出」セクションをタップして、詳細な支出レポートとより深い分析を表示します。

**手順**:
1. レポート概要画面から、**カテゴリ別の支出**セクションまでスクロール
2. 最も高いパーセンテージの上位5カテゴリを確認
3. 「カテゴリ別の支出」カード（右矢印アイコン付き）をタップ
4. アプリが同じ画面の**支出レポート**セクションに自動的にスクロール
5. 完全な詳細を確認: 総支出、定期支出、カテゴリ別の日々の支出（上位5つ以上）、支出急増、傾向と履歴

**ワイヤーフレーム**: `wf-bao-cao.md` - 「カテゴリ別の支出」セクションを参照

### 5.8 REPORT-08: データが不十分な場合にレポートを表示（最初の月）

**目標**: 新しいアプリユーザーが最初の月にレポートを表示し、比較と傾向分析のためのデータが不十分な場合。

**手順**:
1. **レポート**タブに移動
2. **財務の健全性**セクションを確認：
   - 貯蓄目標と実際の貯蓄（予算が存在する場合）
   - 式を含む正味キャッシュフロー
   - 予算の残り（存在する場合）
   - **表示されない**: 「支出ペース」（前月のデータなし）
3. **将来の傾向予測**セクションを確認（予算 > 0の場合）
4. **収入レポート**をタップ: 今月の総収入、定期と臨時収入、**表示されない**「3ヶ月の傾向」、履歴には**「今月」のみ**表示
5. **支出レポート**をタップ: 今月の総支出、定期と日々の支出、**表示されない**「支出急増」、「3ヶ月の傾向」、履歴には**「今月」のみ**表示

**ワイヤーフレーム**: `wf-bao-cao.md` - 条件付き表示のカードを参照

## 6. ロジックとルール

### 6.1 正味キャッシュフロー計算

**式**:
```
正味キャッシュフロー_月 = 
  （月に実際に受領した定期収入 + 月の臨時収入）
  - （月に実際に支払った定期支出 + 月の日々の支出 + 月の実際のローン返済）
```

**詳細**:
- **収入**: SUM(recurring_income_occurrence.amount_snapshot) WHERE status = 'COMPLETED' AND due_date in month + SUM(extra_income.amount) WHERE occurred_at in month
- **支出**: SUM(recurring_expense_occurrence.amount_snapshot) WHERE status = 'COMPLETED' AND due_date in month + SUM(daily_expense.amount) WHERE occurred_at in month + SUM(bank_debt_payment.total_amount) WHERE due_date in month AND status != 'CANCELLED'
- **実際の貯蓄**: max(正味キャッシュフロー_月, 0) - 正味キャッシュフローがプラスの場合: 貯蓄 = 正味キャッシュフロー、正味キャッシュフローがマイナスの場合: 貯蓄 = 0（支出超過）

### 6.2 貯蓄目標達成レベル

**式**:
```
比率 = 貯蓄_月 / budget.savings_amount
進捗% = round(比率 × 100)
```

**しきい値**:
- **良好**: 進捗% ≥ 90
- **中**: 70 ≤ 進捗% < 90
- **不良**: 進捗% < 70

### 6.3 予算の残り

**式**:
- % 予算の残り = （予算の残り / 総予算）× 100
- % 時間の残り = （残り日数 / 月の総日数）× 100

**結論**:
- % 予算 ≈ % 時間の場合: 支出ペースは**適切**
- % 予算 < % 時間の場合: ペースより**速く**支出
- % 予算 > % 時間の場合: ペースより**遅く**支出

**注意**: このカードは、今月の予算が作成されている場合のみ表示されます。

### 6.4 月末予測

**予想支出**:
```
予想支出 = 
  （平均日次支出 × 月の残り日数）
  + 月の残りの総定期支出保留中
  + 月の総銀行ローン返済保留中
```

**詳細**:
- 平均日次支出 = （月初から今日までの総daily_expense.amount）/ 月の経過日数
- 総定期支出保留中 = SUM(recurring_expense_occurrence.amount_snapshot) WHERE status = 'PENDING' AND due_date between 明日 and 月末
- 総銀行ローン返済保留中 = SUM(bank_debt_payment.total_amount) WHERE due_date between 明日 and 月末 AND status = 'PENDING'

**月末の予想残額**:
```
月末の予想残額 = 正味キャッシュフロー_月 - 予想支出
```

**貯蓄目標達成確率**:
```
比率 = 月末の予想残額 / budget.savings_amount
進捗% = round(比率 × 100)
```

**ラベル**:
- ≥ 90% → **達成する**
- 70–89% → **ほぼ達成**
- < 70% → **達成困難**

**注意**: 予測は予算 > 0の場合のみ表示されます。

### 6.5 実際のデータ vs 計画

- **すべてのレポートデータは実際のデータを使用**:
  - 収入: COMPLETED発生 + extra_income
  - 支出: COMPLETED発生 + daily_expense
  - ローン返済: 月のdue_dateを持つbank_debt_payment（支払済みかどうかに関わらず）
- **計画データを使用しない**（まだ期日ではないPENDING発生）

## 7. 重要な注意事項

- **今月のデータのみ**: レポートは今月のデータのみを表示します
- **表示条件**:
  - 「予算の残り」カードは、今月の予算が作成されている場合のみ表示されます
  - 「支出ペース」カードは、比較のための前月のデータが利用可能な場合のみ表示されます
  - 「ローン義務」カードは、ローンが存在する場合のみ表示されます
  - 「予算」メニュー項目は、予算が作成されている場合のみ表示されます
  - 「貯蓄」メニュー項目は、貯蓄口座が存在する場合のみ表示されます
  - 「ローン」メニュー項目は、ローンが存在する場合のみ表示されます
  - 「将来の傾向予測」セクションは、予算 > 0の場合のみ表示されます
- **予測は参考のみ**: 現在の傾向とPENDING項目に基づきます
- **最初の月**: 比較データの不足により、一部のカード/セクションが表示されません（例：「支出ペース」、「3ヶ月の傾向」、「支出急増」）
- **カードはタップ可能**: カードをタップすると、同じ画面の対応する詳細レポートにスクロールします

