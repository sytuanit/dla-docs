# 特殊场合

## 1. 目的

**特殊场合**模块可帮助您管理全年中的特殊场合并为其做准备，包括：
- 管理特殊场合（生日、节日等）
- 创建待办事项清单（准备步骤）
- 为每个准备步骤附加清单
- 场合前的提醒
- 追踪准备进度

## 2. 使用时机

当您想：
- 管理全年中的特殊场合时
- 为重要场合做准备时
- 创建待办事项清单时
- 在场合前收到提醒时

## 3. 相关画面

- 特殊场合清单
- 新增特殊场合
- 场合详细信息和准备步骤
- 新增准备步骤
- 选择清单
- 创建新清单

## 4. 主要使用方式

### 4.1 新增特殊场合

1. 前往**功能** → 选择**特殊场合**
2. 点击 **+** (FAB) 按钮
3. 填写信息：
   - **场合名称**：（例如："妈妈的生日"）
   - **日期**：选择日/月（日期选择器仅选择日/月，无年份）
   - **使用农历**：（可选）如果要使用农历，请勾选
     - 如果勾选：输入农历日和月，应用程序自动计算最近的阳历日期
   - **重复**：每年 / 仅今年
   - **显示通知时间**：选择时间（必填，例如：07:00）
   - **备注**：附加信息（可选）
4. （可选）添加准备步骤（见 4.2）
5. 点击**保存**

### 4.2 新增准备步骤

1. 新增场合时：在"准备步骤"部分点击 **+ 新增步骤**
2. 或从场合详细信息：点击 **+ 新增步骤**
3. 填写信息：
   - **何时？**："X 天前"或"当天"
   - **天数**：（如果选择"X 天前"）输入场合前的天数
   - **显示通知时间**：选择时间（必填）
   - **每天重复直到完成**：（可选）如果需要每日提醒，请勾选
   - **内容**：步骤名称（必填，例如："买礼物"）
   - **备注**：（可选）
   - **使用清单**：（可选）勾选以链接购物清单
4. 点击**新增**（或 FAB"应用"）

### 4.3 创建清单

1. 新增准备步骤时，勾选**使用清单**
2. "选择购物清单"画面自动打开
3. 点击 FAB **+** 创建新清单
4. 输入清单名称
5. 添加项目：
   - 输入项目名称
   - 点击 **+** 添加新项目
6. 点击**保存**
7. 新清单自动选中并返回"新增准备步骤"画面

### 4.4 将步骤标记为完成

1. 前往特殊场合详细信息
2. 找到要标记的步骤
3. 点击复选框 [ ] 更改为 [✓]
4. 如果有清单，点击清单名称查看并勾选/取消勾选项目

### 4.5 查看进度

1. 前往特殊场合详细信息
2. 查看"概览"部分：
   - 准备步骤：步骤总数
   - 已完成：已勾选的步骤数 / 总步骤数
   - 状态：未开始 / 进行中 / 已完成

### 4.6 编辑特殊场合

1. 前往特殊场合详细信息
2. 点击标题中的超链接**编辑 ›**
3. 编辑信息：名称、日期、重复、提醒时间、备注
4. 点击**保存**

### 4.7 编辑准备步骤

1. 前往特殊场合详细信息
2. 点击要编辑的步骤（点击整个项目，删除图标除外）
3. 编辑信息：时间、内容、清单
4. 点击**应用**（或 FAB）

## 5. 示例与用户界面图示

### OCCASION-01：创建新特殊场合（带准备步骤的生日）

**目标**：创建新特殊场合（生日）并添加准备步骤，以便应用程序在场合发生前自动提醒您。

**主要步骤**：
1. 前往功能 → 特殊场合 → 点击"+"(FAB) 按钮
2. 输入场合名称，选择日期（01/05），选择重复"每年"，选择提醒时间（07:00）
3. 添加准备步骤 1："7 天前 – 08:00" - "买礼物"
4. 添加准备步骤 2："1 天前 – 19:00" - "订购蛋糕"
5. 点击"保存"

**线框图 - 新增特殊场合画面**：

```text
┌──────────────────────────────────────────────┐
│ <  新增特殊场合                                │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│ 📝 场合信息                                   │
│                                               │
│ 场合名称 *                                    │
│ [ 安的生日                          ]         │
│                                               │
│ 日期                                          │
│ [ 01 / 05            ▼ ]                      │
│ （日期选择器仅选择日/月）                     │
│                                               │
│ [ ] 使用农历                                   │
│                                               │
│ 重复                                          │
│ (•) 每年                                      │
│ ( ) 仅今年                                    │
│                                               │
│ 显示通知时间 *                                │
│ [ 07:00        ▼ ]                            │
│                                               │
│ 备注（可选）                                  │
│ [                                      ]      │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│ 📋 准备步骤          [ + 新增步骤 ]          │
│ ┌──────────────────────────────────────────┐ │
│ │  1. 买礼物                   [图标删除]   │ │
│ │     7 天前 – 08:00                       │ │
│ │ ──────────────────────────────────────── │ │
│ │  2. 订购蛋糕                   [图标删除] │ │
│ │     1 天前 – 19:00                       │ │
│ └──────────────────────────────────────────┘ │
└──────────────────────────────────────────────┘

        [ 取消 ]                        [ 保存 ]
```

---

### OCCASION-02：使用农历创建特殊场合（带购物清单的纪念日）

**目标**：使用农历创建特殊场合（纪念日）并添加链接到购物清单的准备步骤，以追踪供品购买。

**主要步骤**：
1. 前往功能 → 特殊场合 → 点击"+"(FAB) 按钮
2. 输入场合名称"妈妈的纪念日"，勾选"使用农历"
3. 输入农历日期：15/11，应用程序自动计算阳历日期：12/15/2025
4. 添加 3 个准备步骤，其中步骤 2 有清单链接"买供品"
5. 点击"保存"

**线框图 - 选择农历日期**：

```text
│ │ │ 农历日期                                   │ │ │
│ │ │ 日（1-30）   月（1-12）                    │ │ │
│ │ │ [ 15 ]        [ 11 ]                        │ │ │
│ │ │                                               │ │ │
│ │ │ 阳历日期（自动计算 - 仅显示）                │ │ │
│ │ │ [ 文本：12/15/2025                 ]         │ │ │
│ │ │ （这是未来最近的阳历日期）                  │ │ │
```

---

### OCCASION-03：查看特殊场合清单和详细信息

**目标**：查看特殊场合概览，按时间筛选，并查看每个场合及其准备进度的详细信息。

**主要步骤**：
1. 前往功能 → 特殊场合
2. 查看带有筛选"全部"、"即将到来"、"本月"的清单
3. 点击场合卡片查看详细信息
4. 查看概览：步骤数、已完成、状态
5. 通过勾选复选框将步骤标记为完成

**线框图 - 特殊场合清单画面**：

```text
┌────────────────────────────────────────────────────────────┐
│ 📅 特殊场合清单                                             │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [ + 新增场合 ]                                          │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 🔍 筛选：[ 全部 ]  [ 即将到来 ]  [ 本月 ]              │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📌 妈妈的纪念日    [进行中] [图标删除]                │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 📅 12/15/2025 • 15/11（农历）• 剩余 10 天          │ │ │
│ │ │                                                      │ │ │
│ │ │ ✅ 需要的准备步骤：                                  │ │ │
│ │ │   [✓] 3 天前 – 列出供品                              │ │ │
│ │ │   [ ] 1 天前 – 去购买供品                           │ │ │
│ │ │   [ ] 当天 – 准备祭坛/仪式                           │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
```

**线框图 - 特殊场合详细信息画面**：

```text
┌─────────────────────────────────────────────────────────┐
│ 📋 特殊场合详细信息                                       │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📌 妈妈的纪念日                       [编辑 ›]        │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 12/15/2025（阳历）• 15/11（农历）                │ │ │
│ │ │ 剩余 10 天 • 重复：每年                            │ │ │
│ │ │                                                      │ │ │
│ │ │ 备注：                                               │ │ │
│ │ │ 小餐，白花，限制客人。                              │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📊 概览                                                │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 准备步骤：3                                        │ │ │
│ │ │ 已完成：1 / 3                                     │ │ │
│ │ │ 状态：[进行中]                                    │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📝 准备步骤                  [ + 新增步骤 ]            │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ [✓] 列出供品                    [图标删除]          │ │ │
│ │ │     3 天前 – 08:00                                 │ │ │
│ │ │     完成于 09:15 – 12/12/2025                      │ │ │
│ │ │ ──────────────────────────────────────────────────── │ │ │
│ │ │                                                      │ │ │
│ │ │ [ ] 去购买供品            [图标删除]                │ │ │
│ │ │     1 天前 – 19:00                                  │ │ │
│ │ │     每天重复直到完成                                │ │ │
│ │ │     购物清单：买供品 ›                              │ │ │
│ │ │     [✓] 已完成 3 / 8 项                            │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
```

---

### OCCASION-04：添加带购物清单的准备步骤

**目标**：为特殊场合添加新准备步骤并链接到购物清单以追踪购物。

**主要步骤**：
1. 前往特殊场合详细信息 → 点击"+ 新增步骤"
2. 选择"何时？"："X 天前"，输入天数：1
3. 选择提醒时间：19:00
4. 启用"每天重复直到完成"
5. 输入内容："去购买供品"
6. 勾选"使用清单" → 选择清单"买供品"
7. 点击"新增"

**线框图 - 新增准备步骤画面**：

```text
┌────────────────────────────────────────────────────────────┐
│ ➕ 新增准备步骤                                             │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ ⏰ 准备时间                                              │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 何时？*（必填）                                    │ │ │
│ │ │ [ X 天前         ▼ ]                              │ │ │
│ │ │                                                      │ │ │
│ │ │ 天数 *（仅在"X 天前"时显示）                        │ │ │
│ │ │ [  1  ]  天前                                      │ │ │
│ │ │                                                      │ │ │
│ │ │ 显示通知时间 *（必填）                               │ │ │
│ │ │ [ 19:00        ▼ ]                                 │ │ │
│ │ │                                                      │ │ │
│ │ │ [✓] 每天重复直到完成                                │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 📝 内容                                                 │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ 内容 *（必填）                                      │ │ │
│ │ │ [ 去购买供品                               ]        │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 🔗 链接到购物清单？                                    │ │
│ │ ┌────────────────────────────────────────────────────┐ │ │
│ │ │ ☑ 使用清单                                          │ │ │
│ │ │ 购物清单：买供品 ›    [图标交换]                    │ │ │
│ │ │ （8 项）                                            │ │ │
│ │ └────────────────────────────────────────────────────┘ │ │
│ └────────────────────────────────────────────────────────┘ │
│                                                              │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [ 取消 ]                        [ 新增 ]               │ │
│ └────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

---

### OCCASION-05：将准备步骤标记为完成并查看清单进度

**目标**：将准备步骤标记为完成并追踪购物清单进度。

**主要步骤**：
1. 前往特殊场合详细信息
2. 查看带有清单的步骤，显示进度"已完成 3 / 8 项"
3. 点击清单名称查看详细信息并勾选/取消勾选项目
4. 勾选步骤复选框以标记为完成
5. 实时查看"概览"更新

---

### OCCASION-06：编辑特殊场合和准备步骤

**目标**：创建后编辑特殊场合信息和准备步骤。

**主要步骤**：
1. 前往特殊场合详细信息 → 点击"编辑 ›"
2. 编辑场合名称、备注
3. 点击"保存"
4. 点击步骤进行编辑：更改时间、内容
5. 点击删除图标删除步骤（有确认对话框）

## 6. 逻辑与规则

### 6.1 农历日期

- 您可以输入阳历和农历日期
- 应用程序自动计算与农历日期对应的阳历日期
- 支持按农历每年重复

### 6.2 重复

- **每年**：场合每年重复（按阳历或农历）
  - 使用阳历：每年根据阳历日期的（日/月）计算 nextOccurDate
  - 使用农历：每年从农历日期转换为对应的阳历日期并更新 nextOccurDate
- **仅今年**：场合仅在当年有效，明年不重复

### 6.3 准备步骤

- **何时？**：有 2 个选项：
  - **X 天前**：在场合日期前 X 天提醒（必须输入天数）
  - **当天**：在场合日期提醒（无需输入天数）
- **显示通知时间**：提醒时间（必填，格式 HH:mm）
- **每天重复直到完成**：如果启用，通知将每天重复，直到用户将步骤标记为完成
- **链接清单**：每个步骤可以附加购物清单以追踪购物进度

### 6.4 清单

- 清单可以重复用于多个步骤
- 追踪已完成项目数 / 总项目数（例如："已完成 3 / 8 项"）
- 在步骤详细信息中显示，带有链接"清单名称 ›"以查看详细信息
- 可以在清单中勾选/取消勾选项目以更新进度
- 即使清单未完全完成，也可以将准备步骤标记为完成

### 6.5 通知

- **主要场合通知**：在 `nextOccurDate + reminder_time` 创建
  - 使用每年场合：应用程序启动时会重建通知（基于新计算的 nextOccurDate）
  - 使用一次场合：仅为当前 nextOccurDate 创建一次通知
- **准备步骤通知**：根据以下项目计算提醒日期：
  - 特殊场合的 `nextOccurDate`
  - `reminderType` 和 `daysBefore`（如有）
  - `reminderTime`
- **重复通知**：如果 `repeatDailyUntilComplete = true`：
  - 创建每日重复通知
  - 使用 `notificationGroupKey` 对重复通知进行分组
  - 用户将步骤标记为完成时自动取消

## 7. 重要注意事项

- **农历日期**：
  - 应用程序自动转换为阳历以显示
  - 查找与当前日期相比"未来最近的阳历日期"
  - 未来年份：系统每年总是从（农历日、农历月）重新计算对应的阳历日期
  - 如果该年有同一月的正常月和闰月：系统可能创建 2 个提醒以避免遗漏
- **每年重复**：
  - 场合将在明年自动重新计算 nextOccurDate
  - 使用农历：每年从农历日期转换为对应的阳历日期
- **提醒时间**：
  - 必须有值（不能为空）
  - 必须是正确格式 HH:mm（00:00 - 23:59）
- **清单**：
  - 已删除的清单仍显示在步骤中（但无法编辑）
  - 即使清单未完全完成，也可以将步骤标记为完成
- **通知**：
  - 需要在设置中启用通知以接收提醒
  - 将步骤标记为完成时，重复通知将自动取消
- **场合状态**：
  - **未开始**：所有步骤均未完成（灰色）
  - **进行中**：至少 1 个步骤已完成但未全部完成（蓝色）
  - **已完成**：所有步骤均已完成（深绿色）
  - 如果场合没有准备步骤：状态按日期计算（未开始 / 进行中 / 已完成）

